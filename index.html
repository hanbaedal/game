<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°íŒ… í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body class="bg-black text-white">

    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <header class="flex justify-between items-center px-6 py-4 border-b border-gray-700">
        <div class="flex items-center space-x-3">
            <a href="https://ppadun9-home.netlify.app/" class="cursor-pointer" target="_blank">
                <img src="/img/logo.png" width="40" height="8" alt="PPADUN ë¡œê³ ">
            </a>
            <span id="userNameDisplay" class="text-xs font-bold text-blue-200"></span>
        </div>
        <div class="flex space-x-6">
            <div id="loginButton" class="text-center cursor-pointer" onclick="location.href='/login.html'" style="display: block;">
                <i class="fas fa-sign-in-alt text-2xl"></i>
                <p class="text-sm mt-1">ë¡œê·¸ì¸</p>
            </div>
            <div id="logoutButton" class="text-center cursor-pointer" onclick="logout()" style="display: none;">
                <i class="fas fa-sign-out-alt text-2xl"></i>
                <p class="text-[0.4rem] mt-1">ë¡œê·¸ì•„ì›ƒ</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='settings.html'">
                <i class="fas fa-cog text-2xl"></i>
                <p class="text-[0.4rem] mt-1">ì„¤ì •</p>
            </div>

        </div>
    </header>

    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <main class="p-4">
        <div class="bg-gray-800 max-w-lg mx-auto p-6 rounded-lg">
            <p class="text-right text-gray-300 mb-4" id="currentDate"></p>

            <!-- ë°°íŒ… í¼ -->
            <div class="space-y-4">
                <div class="flex items-center space-x-3">
                    <img src="/img/menu1.png" width="50" height="50" alt="ê²½ê¸° ì´ë¯¸ì§€" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">ê²½ê¸°ì„ íƒ</p>
                        <div id="gameSelectionContainer" class="flex overflow-x-auto space-x-2 bg-gray-800 rounded p-2 border border-gray-600">
                            <!-- ê²½ê¸° ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                    </div>
                </div>

                <!-- ê²Œì„ì„ íƒ + ë°°íŒ…í¬ì¸íŠ¸ í•œ ì¤„ ë°°ì¹˜ -->
                <div class="flex items-center space-x-6 mb-4">
                    <!-- ê²Œì„ì„ íƒ(íƒ€ì) -->
                <div class="flex items-center space-x-3">
                    <img src="/img/menu2.png" width="50" height="50" alt="ê²Œì„ ì´ë¯¸ì§€" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">ê²Œì„ì„ íƒ</p>
                            <div class="grid grid-cols-1 gap-2 mt-2">
                            <button id="batterBtn" class="game-type-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded active" data-type="batter">
                                íƒ€ì
                            </button>
                            </div>
                        </div>
                    </div>
                    <!-- ë°°íŒ…í¬ì¸íŠ¸(ì´ë¯¸ì§€+ì œëª©+100) -->
                    <div class="flex items-center space-x-3">
                        <img src="/img/menu4.png" width="50" height="50" alt="ë°°íŒ…ê¸ˆì•¡ ì´ë¯¸ì§€" class="rounded">
                        <div class="flex-1">
                            <p class="text-sm">ë°°íŒ…í¬ì¸íŠ¸</p>
                            <div class="grid grid-cols-1 gap-1 mt-2">
                                <button class="bet-amount-btn bg-yellow-500 hover:bg-yellow-400 text-black text-xs py-2 px-1 rounded" data-amount="100">
                                    100
                            </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <img src="/img/menu3.png" width="50" height="50" alt="ë°°íŒ… ì´ë¯¸ì§€" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">ë°°íŒ…ì„ íƒ</p>
                        <div id="bettingSection" class="space-y-2 mt-2">
                            <div class="grid grid-cols-3 gap-1">
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded cursor-pointer" data-choice="1base">
                                    1ë£¨
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded cursor-pointer" data-choice="2base">
                                    2ë£¨
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded cursor-pointer" data-choice="3base">
                                    3ë£¨
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded cursor-pointer" data-choice="homerun">
                                    í™ˆëŸ°
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded cursor-pointer" data-choice="strikeout">
                                    ì‚¼ì§„
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded cursor-pointer" data-choice="out">
                                    ì•„ì›ƒ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <p class="mt-4 text-sm">ë³´ìœ  í¬ì¸íŠ¸ : <span id="userPoints" class="font-bold">0í¬ì¸íŠ¸</span> 
                    <span id="afterBettingPoints" class="text-yellow-400 ml-2" style="display: none;">
                        â†’ <span class="font-bold">0í¬ì¸íŠ¸</span>
                    </span>
                </p>

                <!-- ë°°íŒ… ìƒíƒœ í‘œì‹œ -->
                <div id="bettingStatusDisplay" class="mt-4 p-3 rounded-lg" style="display: none;">
                    <div class="flex items-center space-x-3">
                        <div id="bettingStatusIndicator" class="w-4 h-4 rounded-full"></div>
                        <span id="bettingStatusText" class="font-bold text-sm"></span>
                    </div>
                </div>



                <!-- ë°°íŒ… ê²°ê³¼ í‘œì‹œ -->
                <div id="bettingResultDisplay" class="mt-4 p-3 rounded-lg" style="display: none;">
                    <h4 class="font-bold mb-2">ë°°íŒ… ê²°ê³¼</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-300">ì‹¤ì œ ê²°ê³¼:</span>
                            <span id="actualResult" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">ë‚´ ì˜ˆì¸¡:</span>
                            <span id="myPrediction" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">ê²°ê³¼:</span>
                            <span id="bettingResult" class="font-bold"></span>
                        </div>
                        <div id="winAmountDisplay" class="flex justify-between" style="display: none;">
                            <span class="text-gray-300">íšë“ í¬ì¸íŠ¸:</span>
                            <span id="winAmount" class="font-bold text-green-400"></span>
                        </div>
                    </div>
                </div>

                <button id="betBtn" class="flex items-center justify-center space-x-2 w-full py-3 mt-4 bg-yellow-300 text-black font-bold rounded">
                    <i class="fas fa-user-tie"></i>
                    <span>ë°°íŒ…í•˜ê¸°</span>
                </button>

                <button id="resultBtn" class="flex items-center justify-center space-x-2 w-full py-3 mt-2 bg-blue-500 text-white font-bold rounded hidden">
                    <i class="fas fa-chart-line"></i>
                    <span>ê²°ê³¼ í™•ì¸</span>
                </button>

            </div>

            <!-- ìŠ¹ë¦¬ í¬ì¸íŠ¸ ê¸°ë¶€ ëª¨ë‹¬ -->
            <div id="donationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <p class="font-bold text-center text-lg mb-4">ìŠ¹ë¦¬ í¬ì¸íŠ¸ ê¸°ë¶€</p>
                    <p class="text-sm text-center mb-6">ì¶•í•˜ë“œë¦½ë‹ˆë‹¤! ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤.<br>íšë“í•˜ì‹  í¬ì¸íŠ¸ ì¤‘ ì¼ë¶€ë¥¼ ê¸°ë¶€ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>

                    <div class="flex flex-col space-y-4 mb-6" id="donationOptions">
                        <div class="grid grid-cols-2 gap-4">
                            <button class="donation-btn bg-gray-600 px-4 py-2 rounded hover:bg-gray-500" data-percent="10">10%</button>
                            <button class="donation-btn bg-gray-600 px-4 py-2 rounded hover:bg-gray-500" data-percent="15">15%</button>
                            <button class="donation-btn bg-gray-600 px-4 py-2 rounded hover:bg-gray-500" data-percent="20">20%</button>
                            <button class="donation-btn bg-gray-600 px-4 py-2 rounded hover:bg-gray-500" data-percent="30">30%</button>
                        </div>
                        <div id="donationConfirm" class="text-center hidden">
                            <p class="text-sm text-yellow-400 mt-2">ì„ íƒí•˜ì‹  <span id="selectedPercent"></span>ë¥¼ ê¸°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                            <div class="flex justify-center space-x-4 mt-4">
                                <button id="confirmYesBtn" class="bg-blue-500 px-4 py-2 rounded hover:bg-blue-600">ì˜ˆ</button>
                                <button id="confirmNoBtn" class="bg-gray-500 px-4 py-2 rounded hover:bg-gray-600">ì•„ë‹ˆì˜¤</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-around">
                        <button id="donateNoBtn" class="bg-gray-500 px-6 py-2 rounded hover:bg-gray-600">ê¸°ë¶€ì•ˆí•¨</button>
                    </div>
                </div>
            </div>

            <!-- íŒ¨ë°° ê²°ê³¼ ëª¨ë‹¬ -->
            <div id="loseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fas fa-times-circle text-red-500 text-5xl mb-4"></i>
                        <p class="font-bold text-xl mb-2">íŒ¨ë°°</p>
                        <p class="text-sm text-gray-300">ì•„ì‰½ê²Œë„ íŒ¨ë°°í•˜ì˜€ìŠµë‹ˆë‹¤.<br>ë‹¤ìŒ ê¸°íšŒë¥¼ ë…¸ë ¤ë³´ì„¸ìš”!</p>
                    </div>
                    <button id="loseConfirmBtn" class="w-full bg-blue-500 px-6 py-2 rounded hover:bg-blue-600">
                        í™•ì¸
                    </button>
                </div>
            </div>

            <!-- ê²ŒìŠ¤íŠ¸ ìŠ¹ë¦¬ ëª¨ë‹¬ -->
            <div id="guestWinModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fas fa-trophy text-yellow-500 text-5xl mb-4"></i>
                        <p class="font-bold text-xl mb-2">ì¶•í•˜í•©ë‹ˆë‹¤!</p>
                        <p class="text-sm text-gray-300">ìŠ¹ë¦¬í•˜ì…¨ìŠµë‹ˆë‹¤!</p>
                    </div>
                    <button id="guestWinConfirmBtn" class="w-full bg-blue-500 px-6 py-2 rounded hover:bg-blue-600">
                        í™•ì¸
                    </button>
                </div>
            </div>

            <!-- ê¸°ë¶€ ì™„ë£Œ ëª¨ë‹¬ -->
            <div id="donationCompleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fas fa-heart text-red-500 text-5xl mb-4"></i>
                        <p class="font-bold text-xl mb-2">ê¸°ë¶€ ì™„ë£Œ</p>
                        <p class="text-sm text-gray-300" id="donationCompleteMessage"></p>
                    </div>
                    <button id="donationCompleteBtn" class="w-full bg-blue-500 px-6 py-2 rounded hover:bg-blue-600">
                        í™•ì¸
                    </button>
                </div>
            </div>

            <!-- ê²ŒìŠ¤íŠ¸ ì•Œë¦¼ ëª¨ë‹¬ -->
            <div id="guestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <div class="text-center">
                        <p class="text-lg font-bold mb-4 text-red-500">ê²ŒìŠ¤íŠ¸ëŠ” í•´ë‹¹ì‚¬í•­ì´ ì•„ë‹™ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="w-full bg-black text-white py-3 border-t border-gray-700">
        <div class="flex justify-evenly">
            <div class="text-center cursor-pointer" onclick="location.href='invite.html'">
                <i class="fas fa-user-plus text-2xl"></i>
                <p class="text-[0.4rem]">ì´ˆëŒ€</p>
            </div>
            <div class="text-center cursor-pointer" onclick="checkAttendance()">
                <i class="fas fa-calendar-alt text-2xl"></i>
                <p class="text-[0.4rem]">ì¶œì„ë¶€</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='board.html'">
                <i class="fas fa-clipboard text-2xl"></i>
                <p class="text-[0.4rem]">ê²Œì‹œíŒ</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='charge.html'">
                <i class="fas fa-coins text-2xl"></i>
                <p class="text-[0.4rem]">í¬ì¸íŠ¸ì¶©ì „</p>
            </div>
        </div>
    </nav>

    <script>
        // ì „ì—­ ë³€ìˆ˜ë¡œ currentUserì™€ isBetting ì„ ì–¸
        let currentUser = null;
        let isBetting = false;
        let currentWinPoints = 0; // í˜„ì¬ ìŠ¹ë¦¬ í¬ì¸íŠ¸ ì €ì¥ìš©



        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        document.addEventListener('DOMContentLoaded', async () => {
                // localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    
                    // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ (ê²ŒìŠ¤íŠ¸ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ)
                    const displayName = currentUser.isGuest ? 'ê²ŒìŠ¤íŠ¸' : `${currentUser.name}ë‹˜`;
                    document.getElementById('userNameDisplay').textContent = `${displayName} í™˜ì˜í•©ë‹ˆë‹¤!`;
                    
                    // í¬ì¸íŠ¸ í‘œì‹œ
                    document.getElementById('userPoints').textContent = `${currentUser.points}`;
                    
                    // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ ì„¤ì •
                document.getElementById('loginButton').style.display = 'none';
                document.getElementById('logoutButton').style.display = 'block';
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', error);
                    localStorage.removeItem('currentUser');
                    currentUser = null;
                }
            }
            
            // ë¡œê·¸ì¸ ìƒíƒœì— ê´€ê³„ì—†ì´ ê¸°ë³¸ UI ì„¤ì •
            if (!currentUser) {
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('logoutButton').style.display = 'none';
            }

            // ì˜¤ëŠ˜ì˜ ê²½ê¸° ë¡œë“œ (ë¡œê·¸ì¸ ìƒíƒœì— ê´€ê³„ì—†ì´)
            await loadDailyGames();
            
            // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupButtonEventListeners();
            
            // íƒ€ì ìë™ ì„ íƒ ë° ê³ ì •
            const batterBtn = document.querySelector('.game-type-btn[data-type="batter"]');
            if (batterBtn) {
                batterBtn.classList.remove('bg-gray-600');
                batterBtn.classList.add('bg-blue-500', 'active');
                batterBtn.disabled = true;
                batterBtn.classList.add('opacity-50', 'cursor-not-allowed');
                selectedGameType = 'batter';
            }
            // ë‹¤ë¥¸ ê²Œì„íƒ€ì… ë²„íŠ¼ ë¹„í™œì„±í™”
            const otherGameTypeBtns = document.querySelectorAll('.game-type-btn:not([data-type="batter"])');
            otherGameTypeBtns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
            // 100í¬ì¸íŠ¸ ìë™ ì„ íƒ ë° ê³ ì •
            const hundredPointBtn = document.querySelector('.bet-amount-btn[data-amount="100"]');
            if (hundredPointBtn) {
                document.querySelectorAll('.bet-amount-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-500');
                    btn.classList.add('bg-yellow-500');
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                hundredPointBtn.classList.remove('bg-yellow-500');
                hundredPointBtn.classList.add('bg-blue-500');
                selectedBetAmount = 100;
            }
            
            // ë°°íŒ… ìƒíƒœ í™•ì¸ ì‹œì‘
            checkBettingStatus();
            // ë°°íŒ… ìƒíƒœ ì£¼ê¸°ì  í™•ì¸ (1ì´ˆë§ˆë‹¤ - ë¹ ë¥¸ ë°˜ì‘)
            setInterval(checkBettingStatus, 1000);
        });

        // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }



        // ë°°íŒ… ì²˜ë¦¬ í•¨ìˆ˜
        function handleBetting() {
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (!currentUser || !currentUser.userId) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.');
                window.location.href = '/login.html';
                return;
            }

            if (isBetting) return; // ì´ë¯¸ ë°°íŒ… ì¤‘ì´ë©´ ë¦¬í„´

            // ì„ íƒëœ ë°°íŒ… ìœ í˜• í™•ì¸
            const selectedBet = document.querySelector('input[name="betChoice"]:checked');
            if (!selectedBet) {
                alert('ë°°íŒ… ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const betAmount = parseInt(document.getElementById('betAmount').value);
            if (!betAmount || betAmount < 100) {
                alert('ë°°íŒ… í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ìµœì†Œ 100í¬ì¸íŠ¸)');
                return;
            }
            
            // ë³´ìœ  í¬ì¸íŠ¸ í™•ì¸
            if (currentUser.points < betAmount) {
                alert('ë³´ìœ  í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                return;
            }

            // í˜„ì¬ ë‚ ì§œì™€ ì„ íƒëœ ê²½ê¸° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            // í•œêµ­ ì‹œê°„ëŒ€ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
            const now = new Date();
            const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
            const today = koreaTime.getFullYear().toString() + 
                         String(koreaTime.getMonth() + 1).padStart(2, '0') + 
                         String(koreaTime.getDate()).padStart(2, '0');
            
            const selectedGame = getSelectedGame();
            
            if (!selectedGame) {
                alert('ê²½ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì„œë²„ë¡œ ë°°íŒ… ë°ì´í„° ì „ì†¡
            fetch('/api/betting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: today,
                    gameNumber: selectedGame.gameNumber,
                    memberId: currentUser.userId,
                    memberName: currentUser.name,
                    betChoice: selectedBet.value,
                    betAmount: betAmount
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
            // ë°°íŒ… í¬ì¸íŠ¸ ì°¨ê°
                    currentUser.points -= betAmount;
            document.getElementById('userPoints').textContent = `${currentUser.points}`;
            
            // localStorage ì—…ë°ì´íŠ¸
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // ë°°íŒ… ë²„íŠ¼ ìˆ¨ê¸°ê³  ê²°ê³¼ ë²„íŠ¼ í‘œì‹œ
                    document.getElementById('betBtn').style.display = 'none';
                    document.getElementById('resultBtn').style.display = 'block';
            
            // ë°°íŒ… ì¤‘ ìƒíƒœë¡œ ë³€ê²½
            isBetting = true;
                    
                    alert('ë°°íŒ…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('ë°°íŒ… ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                console.error('ë°°íŒ… ì˜¤ë¥˜:', error);
                alert('ë°°íŒ… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        // ì„ íƒëœ ê²½ê¸° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        function getSelectedGame() {
            const selectedGameElement = document.querySelector('.game-item.selected');
            if (selectedGameElement) {
                const gameNumber = selectedGameElement.dataset.gameNumber;
                const homeTeam = selectedGameElement.dataset.homeTeam;
                const awayTeam = selectedGameElement.dataset.awayTeam;
                return { gameNumber, homeTeam, awayTeam };
            }
            return null;
        }

        // ìˆ˜ë™ ë°°íŒ… ì„¸ì…˜ ìƒì„± í•¨ìˆ˜ (í…ŒìŠ¤íŠ¸ìš©)
        async function createBettingSession() {
            try {
                // í•œêµ­ ì‹œê°„ëŒ€ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
                const now = new Date();
                const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
                const today = koreaTime.getFullYear().toString() + 
                             String(koreaTime.getMonth() + 1).padStart(2, '0') + 
                             String(koreaTime.getDate()).padStart(2, '0');
                
                const response = await fetch('/api/betting/create-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: today,
                        gameNumber: 1,
                        inning: 1
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('ë°°íŒ… ì„¸ì…˜ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    // ë°°íŒ… ìƒíƒœ ì¦‰ì‹œ í™•ì¸
                    checkBettingStatus();
                } else {
                    alert('ë°°íŒ… ì„¸ì…˜ ìƒì„± ì‹¤íŒ¨: ' + data.message);
                }
            } catch (error) {
                console.error('ë°°íŒ… ì„¸ì…˜ ìƒì„± ì˜¤ë¥˜:', error);
                alert('ë°°íŒ… ì„¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë°°íŒ… ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        async function showBettingResult() {
            if (!isBetting) return;
            
            try {
                const selectedGame = getSelectedGame();
                if (!selectedGame) {
                    alert('ì„ íƒëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // í•œêµ­ ì‹œê°„ëŒ€ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
                const now = new Date();
                const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
                const today = koreaTime.getFullYear().toString() + 
                             String(koreaTime.getMonth() + 1).padStart(2, '0') + 
                             String(koreaTime.getDate()).padStart(2, '0');
                
                // ì„œë²„ì—ì„œ ë°°íŒ… ê²°ê³¼ ì¡°íšŒ
                const response = await fetch(`/api/betting/results?date=${today}&gameNumber=${selectedGame.gameNumber}`);
                const data = await response.json();
                
                // ì‚¬ìš©ìì˜ ë°°íŒ… ê²°ê³¼ ì°¾ê¸°
                const myResult = data.bets.find(b => b.memberId === currentUser.userId);
                
                if (myResult) {
                    if (myResult.isWinner) {
                        // ìŠ¹ë¦¬ ì‹œ í¬ì¸íŠ¸ ì¶”ê°€
                        currentUser.points += myResult.winAmount;
                        document.getElementById('userPoints').textContent = `${currentUser.points}`;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    if (currentUser.isGuest) {
                        showGuestWinModal();
                    } else {
                            showDonationModal(myResult.winAmount); // ìŠ¹ë¦¬ í¬ì¸íŠ¸ë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬
                        document.getElementById('donationOptions').style.display = 'block';
                    }
                } else {
                    showLoseModal();
                    }
                } else {
                    alert('ë°°íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.');
                }

                // ë°°íŒ… ë²„íŠ¼ ë³µì›
                document.getElementById('betBtn').style.display = 'block';
                document.getElementById('resultBtn').style.display = 'none';
                
                // ë°°íŒ… ìƒíƒœ ì´ˆê¸°í™”
                isBetting = false;


            } catch (error) {
                console.error('ë°°íŒ… ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë°°íŒ… ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }



        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        function showGuestWinModal() {
            document.getElementById('guestWinModal').style.display = 'flex';
        }

        function showDonationModal(winPoints = 0) {
            const modal = document.getElementById('donationModal');
            modal.style.display = 'flex';
            
            // ê¸°ë¶€ ì˜µì…˜ ë²„íŠ¼ë“¤ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.querySelectorAll('.donation-btn').forEach(btn => {
                btn.onclick = function() {
                    const percent = parseInt(this.dataset.percent);
                    const donateAmount = Math.floor(winPoints * percent / 100);
                    
                    // ê¸°ë¶€ í™•ì¸ ì„¹ì…˜ í‘œì‹œ
                    document.getElementById('selectedPercent').textContent = `${percent}% (${donateAmount}í¬ì¸íŠ¸)`;
                    document.getElementById('donationConfirm').classList.remove('hidden');
                    
                    // ì˜ˆ ë²„íŠ¼ ì´ë²¤íŠ¸
                    document.getElementById('confirmYesBtn').onclick = function() {
                        processDonation(donateAmount, percent);
                    };
                    
                    // ì•„ë‹ˆì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸
                    document.getElementById('confirmNoBtn').onclick = function() {
                        document.getElementById('donationConfirm').classList.add('hidden');
                    };
                };
            });
            
            // ê¸°ë¶€ì•ˆí•¨ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('donateNoBtn').onclick = function() {
                modal.style.display = 'none';
                document.getElementById('donationConfirm').classList.add('hidden');
            };
        }

        function showLoseModal() {
            document.getElementById('loseModal').style.display = 'flex';
        }

        // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        document.getElementById('donateNoBtn').addEventListener('click', () => {
            document.getElementById('donationModal').style.display = 'none';
            // ê¸°ë¶€í•˜ì§€ ì•Šì„ ê²½ìš° ì„œë²„ì— ìµœì¢… í¬ì¸íŠ¸ë§Œ ì—…ë°ì´íŠ¸
            if (!currentUser.isGuest) {
                updateServerPoints(currentUser.points);
            }
        });

        document.getElementById('loseConfirmBtn').addEventListener('click', () => {
            document.getElementById('loseModal').style.display = 'none';
        });

        document.getElementById('guestWinConfirmBtn').addEventListener('click', () => {
            document.getElementById('guestWinModal').style.display = 'none';
        });

        // ì„œë²„ í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        async function updateServerPoints(points) {
            try {
                const response = await fetch('/api/update-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        points: points
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    console.error('í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', data.message);
                }
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            }
        }

        // ê¸°ë¶€ ì²˜ë¦¬ í•¨ìˆ˜
        async function processDonation(donationAmount, percentage) {
            const finalPoints = currentUser.points - donationAmount;
            // í•œêµ­ ì‹œê°„ëŒ€ë¡œ ì˜¤ëŠ˜ ë‚ ì§œ ê³„ì‚°
            const now = new Date();
            const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
            const today = koreaTime.getFullYear().toString() + 
                         String(koreaTime.getMonth() + 1).padStart(2, '0') + 
                         String(koreaTime.getDate()).padStart(2, '0');
            
            try {
                // pointsPerWinner ê°’ì„ ê°€ì ¸ì™€ì„œ ìŠ¹ë¦¬ í¬ì¸íŠ¸ ê³„ì‚°
                const pointsResponse = await fetch('/api/realtime-monitoring/points-per-winner');
                const pointsData = await pointsResponse.json();
                const pointsPerWinner = pointsData.pointsPerWinner || 4000;
                const winAmount = 100 + pointsPerWinner; // ë°°íŒ… í¬ì¸íŠ¸(100) + ì„±ê³µìë‹¹ ë¶„ë°° í¬ì¸íŠ¸
                
                const response = await fetch('/api/donation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        userName: currentUser.name,
                        donationAmount: donationAmount,
                        percentage: percentage,
                        finalPoints: finalPoints,
                        gameDate: today,
                        gameNumber: 1,
                        winAmount: winAmount
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    currentUser.points = finalPoints;
                    document.getElementById('userPoints').textContent = `${finalPoints}í¬ì¸íŠ¸`;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // ê¸°ë¶€ ëª¨ë‹¬ ë‹«ê¸°
                    document.getElementById('donationModal').style.display = 'none';
                    document.getElementById('donationConfirm').classList.add('hidden');
                    
                    // ê¸°ë¶€ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
                    showDonationCompleteModal(donationAmount, percentage);
                } else {
                    alert('ê¸°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
                }
            } catch (error) {
                console.error('ê¸°ë¶€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('ê¸°ë¶€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ê¸°ë¶€ ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        function showDonationCompleteModal(donationAmount, percentage) {
            const modal = document.getElementById('donationCompleteModal');
            const message = document.getElementById('donationCompleteMessage');
            
            message.textContent = `${percentage}% (${donationAmount}í¬ì¸íŠ¸) ê¸°ë¶€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!`;
            modal.style.display = 'flex';
            
            // í™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('donationCompleteBtn').onclick = function() {
                modal.style.display = 'none';
            };
        }

        // ê¸°ë¶€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelectorAll('.donation-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const percentage = parseInt(btn.dataset.percent);
                document.getElementById('selectedPercent').textContent = `${percentage}%`;
                document.getElementById('donationConfirm').classList.remove('hidden');
            });
        });

        // ê¸°ë¶€ í™•ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('confirmYesBtn').addEventListener('click', () => {
            const percentage = parseInt(document.querySelector('.donation-btn.selected')?.dataset.percent || '10');
            handleDonation(percentage);
        });

        document.getElementById('confirmNoBtn').addEventListener('click', () => {
            document.getElementById('donationConfirm').classList.add('hidden');
        });

        // ê¸°ë¶€ ì™„ë£Œ ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('donationCompleteBtn').addEventListener('click', () => {
            document.getElementById('donationCompleteModal').style.display = 'none';
        });

        // í˜„ì¬ ë‚ ì§œ í‘œì‹œ í•¨ìˆ˜
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            };
            const dateString = now.toLocaleDateString('ko-KR', options);
            document.getElementById('currentDate').textContent = dateString;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚ ì§œ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            
            // ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
            setupBrowserCloseLogout();
            
            // ë°°íŒ… ìƒíƒœ í™•ì¸ ì‹œì‘
            startBettingStatusCheck();
        });
        
        // ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ì„¤ì •
        function setupBrowserCloseLogout() {
            // beforeunload ì´ë²¤íŠ¸ (ë¸Œë¼ìš°ì € íƒ­/ì°½ ë‹«ê¸°)
            window.addEventListener('beforeunload', function(e) {
                if (currentUser && !currentUser.isGuest) {
                    // ë¡œê·¸ì•„ì›ƒ API í˜¸ì¶œ
                    navigator.sendBeacon('/api/logout', JSON.stringify({
                        userId: currentUser.userId
                    }));
                }
            });
            
            // pagehide ì´ë²¤íŠ¸ (í˜ì´ì§€ ìˆ¨ê¹€, ëª¨ë°”ì¼ì—ì„œ ë” ì•ˆì •ì )
            window.addEventListener('pagehide', function(e) {
                if (currentUser && !currentUser.isGuest) {
                    // ë¡œê·¸ì•„ì›ƒ API í˜¸ì¶œ
                    navigator.sendBeacon('/api/logout', JSON.stringify({
                        userId: currentUser.userId
                    }));
                }
            });
            
            // visibilitychange ì´ë²¤íŠ¸ (íƒ­ ì „í™˜ ì‹œ)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && currentUser && !currentUser.isGuest) {
                    // íƒ­ì´ ìˆ¨ê²¨ì§ˆ ë•Œë„ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                    navigator.sendBeacon('/api/logout', JSON.stringify({
                        userId: currentUser.userId
                    }));
                }
            });
        }

        // ì˜¤ëŠ˜ì˜ ê²½ê¸° ë¡œë“œ
        async function loadDailyGames() {
            const gameSelectionContainer = document.getElementById('gameSelectionContainer');
            
            try {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                gameSelectionContainer.innerHTML = '<div class="text-center text-gray-400 py-2">ê²½ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
                
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ í™•ì¸
                let userSelection = null;
                
                if (currentUser && currentUser.userId) {
                    // ì‚¬ìš©ìì˜ ê²½ê¸° ì„ íƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    try {
                        const selectionResponse = await fetch(`/api/game-selection/${currentUser.userId}`);
                        if (selectionResponse.ok) {
                            const selectionData = await selectionResponse.json();
                            userSelection = selectionData.selection;
                        }
                    } catch (error) {
                        console.error('ì‚¬ìš©ì ì„ íƒ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                    }
                }
                
                const response = await fetch('/api/daily-games?debug=true');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
                console.log('ğŸ” API ì‘ë‹µ ë°ì´í„°:', data);
                if (data.debug) {
                    console.log('ğŸ”§ ë””ë²„ê·¸ ì •ë³´:', data.debug);
                }
                
                gameSelectionContainer.innerHTML = '';
                
                if (data.games && data.games.length > 0) {
                    // ì „ì²´ ê²½ê¸° ìƒíƒœ í™•ì¸
                    const allGamesBeforeStart = checkAllGamesStatus(data.games);
                    
                    // ì„ íƒëœ ê²½ê¸° ì°¾ê¸°
                    const selectedGame = data.games.find(game => userSelection && userSelection.gameNumber === game.number);
                    
                    // ë“œë¡­ë‹¤ìš´ ì»¨í…Œì´ë„ˆ ìƒì„±
                    const dropdownContainer = document.createElement('div');
                    dropdownContainer.className = 'relative';
                    
                    // ì„ íƒëœ ê²½ê¸° ë˜ëŠ” ê¸°ë³¸ ê²½ê¸° í‘œì‹œ
                    if (selectedGame) {
                        // ì´ë¯¸ ê²½ê¸° ì„ íƒì´ ëœ ê²½ìš°: ì„ íƒëœ ê²½ê¸°ë§Œ í‘œì‹œ, ëª¨ë‹¬ ìƒì„±/í‘œì‹œí•˜ì§€ ì•ŠìŒ
                        dropdownContainer.innerHTML = `
                            <div class="game-dropdown border border-blue-500 bg-blue-900 bg-opacity-20 rounded" style="height: 32px; display: flex; align-items: center; padding: 0 12px;">
                                <div class="flex justify-between items-center w-full">
                                    <div class="flex-1">
                                        <div class="text-xs font-bold">${selectedGame.homeTeam} vs ${selectedGame.awayTeam}</div>
                                        <div class="text-xs text-gray-400">ê²½ê¸° ${selectedGame.number} â€¢ ${getStatusText(selectedGame)}</div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs bg-blue-500 text-white px-2 py-1 rounded">ì„ íƒë¨</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        // ëª¨ë‹¬ ìƒì„±/í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    } else {
                        // ì„ íƒ ì•ˆ ëœ ê²½ìš°: í´ë¦­ ê°€ëŠ¥í•œ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
                        dropdownContainer.innerHTML = `
                            <div class="game-dropdown border border-blue-500 bg-blue-900 bg-opacity-20 rounded hover:bg-blue-800 cursor-pointer" onclick="openGameModal()" style="height: 32px; display: flex; align-items: center; padding: 0 12px;">
                                <div class="flex justify-between items-center w-full">
                                    <div class="flex-1">
                                        <div class="text-xs font-bold text-blue-200">ê²½ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        `;
                    
                        // ëª¨ë‹¬ ìƒì„± (í‘œì‹œí•˜ì§€ ì•ŠìŒ)
                    const modal = document.createElement('div');
                    modal.id = 'gameModal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                    modal.innerHTML = `
                        <div class="bg-gray-800 rounded-lg p-4 max-w-sm w-full mx-4 max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">ê²½ê¸° ì„ íƒ</h3>
                                <button onclick="closeGameModal()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${data.games.map(game => {
                                    const gameStatus = getStatusText(game);
                                        // ê²½ê¸° ì„ íƒ ì¡°ê±´ ìˆ˜ì • - ì‹¤ì œ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ
                                        const gameIsSelectable = (game.progressStatus === 'ê²½ê¸°ì „' || game.progressStatus === 'ê²½ê¸°ì¤‘' || game.progressStatus === 'ê²½ê¸°ì¢…ë£Œ') ||
                                                               (game.gameStatus === 'ì •ìƒê²Œì„' || game.gameStatus === 'ê²½ê¸°ì „' || game.gameStatus === 'ê²½ê¸°ì¤‘');
                                    const gameIsSelected = userSelection && userSelection.gameNumber === game.number;
                                    return `
                                        <div class="game-option p-3 border border-gray-600 rounded-lg hover:bg-gray-700 cursor-pointer ${gameIsSelected ? 'bg-blue-900 border-blue-500' : ''}" 
                                                     onclick="${gameIsSelectable ? `selectGameFromModal(${game.number}, '${game.homeTeam}', '${game.awayTeam}')` : 'alert(\'ì„ íƒí•  ìˆ˜ ì—†ëŠ” ê²½ê¸°ì…ë‹ˆë‹¤.\')'}">
                                            <div class="flex justify-between items-center">
                                                <div class="flex-1">
                                                    <div class="text-sm font-bold">${game.homeTeam} vs ${game.awayTeam}</div>
                                                    <div class="text-xs text-gray-400">ê²½ê¸° ${game.number} â€¢ ${gameStatus}</div>
                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs px-2 py-1 rounded ${getStatusBadgeClass(game)}">
                                                        ${getGameSituationText(game)}
                                                    </span>
                                                    ${gameIsSelectable ? 
                                                        (gameIsSelected ? 
                                                            `<span class="text-xs bg-red-500 text-white px-2 py-1 rounded">ì„ íƒì¤‘</span>` :
                                                            `<span class="text-xs text-blue-500 px-2 py-1">ì„ íƒê°€ëŠ¥</span>`
                                                        ) : 
                                                        `<span class="text-xs text-gray-500 px-2 py-1">ì„ íƒë¶ˆê°€</span>`
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    }
                    
                    // ë“œë¡­ë‹¤ìš´ ì»¨í…Œì´ë„ˆë¥¼ gameSelectionContainerì— ì¶”ê°€
                    gameSelectionContainer.appendChild(dropdownContainer);
                } else {
                    gameSelectionContainer.innerHTML = '<div class="text-center text-gray-400 py-2">ì˜¤ëŠ˜ì˜ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('ê²½ê¸° ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                gameSelectionContainer.innerHTML = '<div class="text-center text-gray-400 py-2">ê²½ê¸° ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function openGameModal() {
            const modal = document.getElementById('gameModal');
            modal.style.display = 'flex';
        }

        function closeGameModal() {
            document.getElementById('gameModal').style.display = 'none';
        }

        async function selectGameFromModal(gameNumber, homeTeam, awayTeam) {
            if (!currentUser || !currentUser.userId) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            try {
                const response = await fetch('/api/game-selection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        gameNumber: gameNumber
                    })
                });
                const data = await response.json();
                if (data && data.message) {
                    closeGameModal();
                    await loadDailyGames();
                } else {
                    alert(data.error || 'ê²½ê¸° ì„ íƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ê²½ê¸° ì„ íƒ ì˜¤ë¥˜:', error);
                alert('ê²½ê¸° ì„ íƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        window.selectGameFromModal = selectGameFromModal;

        // ê²½ê¸° ìƒíƒœ í…ìŠ¤íŠ¸ ë° í´ë˜ìŠ¤ í•¨ìˆ˜
        function getStatusText(game) {
            console.log('ğŸ” ê²½ê¸° ìƒíƒœ í™•ì¸:', {
                gameNumber: game.number,
                progressStatus: game.progressStatus,
                gameStatus: game.gameStatus,
                noGame: game.noGame,
                startTime: game.startTime,
                endTime: game.endTime
            });
            
            // ìš°ì²œì·¨ì†Œ, ê²½ê¸°ì·¨ì†Œ ë“± íŠ¹ë³„í•œ ìƒí™©ì€ ìš°ì„  ì²˜ë¦¬
            if (game.gameStatus === 'ìš°ì²œ' || game.gameStatus === 'ë²ˆê°œ/ì²œë‘¥' || game.gameStatus === 'ê²½ê¸°ì·¨ì†Œ') {
                return game.gameStatus;
            }
            
            // ì‹œê°„ ê¸°ë°˜ ì§„í–‰ìƒíƒœ ê³„ì‚°
            const currentStatus = calculateGameStatusByTime(game);
            if (currentStatus) {
                return currentStatus;
            }
            
            // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í•„ë“œ í™•ì¸ (ë°±ì—…)
            if (game.progressStatus) {
                if (game.progressStatus === 'ê²½ê¸°ì „') return 'ê²½ê¸°ì „';
                if (game.progressStatus === 'ê²½ê¸°ì¤‘') return 'ê²½ê¸°ì¤‘';
                if (game.progressStatus === 'ê²½ê¸°ì¢…ë£Œ' || game.progressStatus === 'ê²½ê¸°ë') return 'ê²½ê¸°ë';
                if (game.progressStatus === 'ê²½ê¸°ì·¨ì†Œ' || game.progressStatus === 'ìš°ì²œì·¨ì†Œ') return game.progressStatus;
                return game.progressStatus;
            }
            
            if (game.gameStatus) {
                if (game.gameStatus === 'ì •ìƒê²Œì„') {
                    if (game.progressStatus === 'ê²½ê¸°ì¤‘') return 'ê²½ê¸°ì¤‘';
                    if (game.progressStatus === 'ê²½ê¸°ì¢…ë£Œ' || game.progressStatus === 'ê²½ê¸°ë') return 'ê²½ê¸°ë';
                    return 'ê²½ê¸°ì „';
                }
                if (game.gameStatus === 'ê²½ê¸°ì¤‘') return 'ê²½ê¸°ì¤‘';
                if (game.gameStatus === 'ê²½ê¸°ì¢…ë£Œ' || game.gameStatus === 'ê²½ê¸°ë') return 'ê²½ê¸°ë';
                return game.gameStatus;
            }
            
            if (game.noGame) {
                if (game.noGame === 'ê²½ê¸°ì¤‘') return 'ê²½ê¸°ì¤‘';
                if (game.noGame === 'ê²½ê¸°ì¢…ë£Œ' || game.noGame === 'ê²½ê¸°ë') return 'ê²½ê¸°ë';
                if (game.noGame === 'ìš°ì²œì·¨ì†Œ' || game.noGame === 'ì·¨ì†Œ') return game.noGame;
                return game.noGame;
            }
            
            return 'ê²½ê¸°ì „';
        }
        
        // ì‹œê°„ ê¸°ë°˜ ê²½ê¸° ìƒíƒœ ê³„ì‚° í•¨ìˆ˜
        function calculateGameStatusByTime(game) {
            if (!game.startTime || !game.endTime) {
                return null; // ì‹œê°„ ì •ë³´ê°€ ì—†ìœ¼ë©´ null ë°˜í™˜
            }
            
            const now = new Date();
            const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
            
            // ì˜¤ëŠ˜ ë‚ ì§œ (YYYY-MM-DD í˜•ì‹)
            const today = koreaTime.getFullYear().toString() + 
                         String(koreaTime.getMonth() + 1).padStart(2, '0') + 
                         String(koreaTime.getDate()).padStart(2, '0');
            
            // ì‹œê°„ íŒŒì‹± (HH:MM í˜•ì‹)
            const parseTime = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const gameDate = new Date(today + 'T' + timeStr + ':00+09:00');
                return gameDate;
            };
            
            try {
                const startTime = parseTime(game.startTime);
                const endTime = parseTime(game.endTime);
                const currentTime = koreaTime;
                
                console.log('â° ì‹œê°„ ê³„ì‚°:', {
                    gameNumber: game.number,
                    startTime: startTime.toISOString(),
                    endTime: endTime.toISOString(),
                    currentTime: currentTime.toISOString(),
                    startTimeMs: startTime.getTime(),
                    endTimeMs: endTime.getTime(),
                    currentTimeMs: currentTime.getTime()
                });
                
                // ì‹œê°„ ë¹„êµ
                if (currentTime < startTime) {
                    return 'ê²½ê¸°ì „';
                } else if (currentTime >= startTime && currentTime <= endTime) {
                    return 'ê²½ê¸°ì¤‘';
                } else if (currentTime > endTime) {
                    return 'ê²½ê¸°ë';
                }
            } catch (error) {
                console.error('ì‹œê°„ íŒŒì‹± ì˜¤ë¥˜:', error);
            }
            
            return null;
        }
        
        function getGameStatusClass(game) {
            if (game.noGame === 'ê²½ê¸°ì¤‘') {
                return 'bg-red-500 text-white';
            } else if (game.noGame === 'ê²½ê¸°ì¢…ë£Œ') {
                return 'bg-gray-600 text-white';
            } else if (game.noGame === 'ìš°ì²œì·¨ì†Œ' || game.noGame === 'ì·¨ì†Œ') {
                return 'bg-yellow-500 text-black';
                } else {
                return 'bg-blue-500 text-white';
            }
        }
        
        function getGameSituationText(game) {
            console.log('ğŸ” ê²½ê¸° ìƒí™© í™•ì¸:', {
                gameNumber: game.number,
                gameStatus: game.gameStatus,
                noGame: game.noGame
            });
            
            // team-games ì»¬ë ‰ì…˜ì˜ gameStatus í•„ë“œ ì‚¬ìš©
            if (game.gameStatus) {
                return game.gameStatus;
            } else if (game.noGame) {
                return game.noGame;
                } else {
                return 'ê²½ê¸°ì „';
            }
        }
        
                function getStatusBadgeClass(game) {
            const status = getStatusText(game);
            
            if (status === 'ê²½ê¸°ì¤‘') {
                return 'bg-red-500 text-white';
            } else if (status === 'ê²½ê¸°ë' || status === 'ê²½ê¸°ì¢…ë£Œ') {
                return 'bg-gray-600 text-white';
            } else if (status === 'ìš°ì²œì·¨ì†Œ' || status === 'ê²½ê¸°ì·¨ì†Œ' || status === 'ë²ˆê°œ/ì²œë‘¥') {
                return 'bg-yellow-500 text-black';
            } else if (status === 'ê²½ê¸°ì „') {
                return 'bg-blue-500 text-white';
            } else {
                return 'bg-gray-500 text-white';
            }
        }

        // ëª¨ë“  ê²½ê¸°ê°€ ê²½ê¸°ì „ì¸ì§€ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
        function checkAllGamesStatus(games) {
            console.log('ğŸ” ì „ì²´ ê²½ê¸° ìƒíƒœ í™•ì¸:', games.map(game => ({
                gameNumber: game.number,
                progressStatus: game.progressStatus,
                gameStatus: game.gameStatus,
                noGame: game.noGame
            })));
            
            return games.every(game => 
                (game.progressStatus === 'ê²½ê¸°ì „') || 
                (game.gameStatus === 'ê²½ê¸°ì „') ||
                (game.noGame === 'ê²½ê¸°ì „' || game.noGame === 'ì •ìƒê²Œì„')
            );
        }
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupButtonEventListeners() {
            const betBtn = document.getElementById('betBtn');
            const resultBtn = document.getElementById('resultBtn');

            if (betBtn) {
                betBtn.addEventListener('click', handleBetting);
            }

            if (resultBtn) {
                resultBtn.addEventListener('click', showBettingResult);
            }
        }
        
        // ë°°íŒ… ìƒíƒœ í™•ì¸ ë° í‘œì‹œ í•¨ìˆ˜
        async function checkBettingStatus() {
            if (!currentUser || currentUser.isGuest) {
                document.getElementById('bettingStatusDisplay').style.display = 'none';
                return;
            }
            
            try {
                const selectedGame = getSelectedGame();
                if (!selectedGame) {
                    document.getElementById('bettingStatusDisplay').style.display = 'none';
                return;
            }
            
                const now = new Date();
                const koreaTime = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
                const today = koreaTime.getFullYear().toString() + 
                             String(koreaTime.getMonth() + 1).padStart(2, '0') + 
                             String(koreaTime.getDate()).padStart(2, '0');
                
                const response = await fetch(`/api/betting/status?date=${today}&gameNumber=${selectedGame.gameNumber}`);
                const data = await response.json();

                if (data.success) {
                    const status = data.status;
                    const indicator = document.getElementById('bettingStatusIndicator');
                    const text = document.getElementById('bettingStatusText');

                    if (indicator && text) {
                        indicator.style.backgroundColor = getStatusColor(status);
                        text.textContent = status;
                        document.getElementById('bettingStatusDisplay').style.display = 'block';
                    }
                } else {
                    console.error('ë°°íŒ… ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', data.message);
                    document.getElementById('bettingStatusDisplay').style.display = 'none';
                }
            } catch (error) {
                console.error('ë°°íŒ… ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                document.getElementById('bettingStatusDisplay').style.display = 'none';
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'ë°°íŒ… ì¤‘':
                    return 'bg-yellow-500';
                case 'ë°°íŒ… ì¤‘ì§€':
                    return 'bg-red-500';
                case 'ê²°ê³¼ ì²˜ë¦¬ ì¤‘':
                    return 'bg-blue-500';
                default:
                    return 'bg-gray-600';
            }
        }
        
        // ì¶œì„ì²´í¬ í•¨ìˆ˜
        function checkAttendance() {
            // ì¶œì„ì²´í¬ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = '/attendance.html';
        }
        
        // ë°°íŒ… ìƒíƒœ ì£¼ê¸°ì  í™•ì¸ ì‹œì‘ í•¨ìˆ˜
        function startBettingStatusCheck() {
            checkBettingStatus();
            setInterval(checkBettingStatus, 1000); // 1ì´ˆë§ˆë‹¤ í™•ì¸
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚ ì§œ í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            
            // ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
            setupBrowserCloseLogout();
            
            // ë°°íŒ… ìƒíƒœ í™•ì¸ ì‹œì‘
            startBettingStatusCheck();
        });
    </script>
</body>
</html> 