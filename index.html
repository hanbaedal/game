<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배팅 페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body class="bg-black text-white">

    <!-- 상단 네비게이션 -->
    <header class="flex justify-between items-center px-6 py-4 border-b border-gray-700">
        <div class="flex items-center space-x-3">
            <a href="https://ppadun9-home.netlify.app/" class="cursor-pointer" target="_blank">
                <img src="/img/logo.png" width="40" height="8" alt="PPADUN 로고">
            </a>
            <span id="userNameDisplay" class="text-xs font-bold text-blue-200"></span>
        </div>
        <div class="flex space-x-6">
            <div id="loginButton" class="text-center cursor-pointer" onclick="location.href='/login.html'" style="display: block;">
                <i class="fas fa-sign-in-alt text-2xl"></i>
                <p class="text-sm mt-1">로그인</p>
            </div>
            <div id="logoutButton" class="text-center cursor-pointer" onclick="logout()" style="display: none;">
                <i class="fas fa-sign-out-alt text-2xl"></i>
                <p class="text-[0.4rem] mt-1">로그아웃</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='settings.html'">
                <i class="fas fa-cog text-2xl"></i>
                <p class="text-[0.4rem] mt-1">설정</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='admin-games.html'">
                <i class="fas fa-tools text-2xl"></i>
                <p class="text-[0.4rem] mt-1">관리자</p>
            </div>
        </div>
    </header>

    <!-- 메인 컨테이너 -->
    <main class="p-4">
        <div class="bg-gray-800 max-w-lg mx-auto p-6 rounded-lg">
            <p class="text-right text-gray-300 mb-4" id="currentDate"></p>

            <!-- 배팅 폼 -->
            <div class="space-y-4">
                <div class="flex items-center space-x-3">
                    <img src="/img/menu1.png" width="50" height="50" alt="경기 이미지" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">경기선택</p>
                        <div id="gameSelectionContainer" class="flex overflow-x-auto space-x-2 bg-gray-800 rounded p-2 border border-gray-600">
                            <!-- 경기 목록이 여기에 동적으로 추가됨 -->
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <img src="/img/menu2.png" width="50" height="50" alt="게임 이미지" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">게임선택</p>
                        <div class="grid grid-cols-3 gap-2 mt-2">
                            <button id="batterBtn" class="game-type-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-3 rounded active" data-type="batter">
                                타자
                            </button>
                            <button id="defenseBtn" class="game-type-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-3 rounded" data-type="defense">
                                수비
                            </button>
                            <button id="pitcherBtn" class="game-type-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-3 rounded" data-type="pitcher">
                                투수
                            </button>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <img src="/img/menu3.png" width="50" height="50" alt="배팅 이미지" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">배팅선택</p>
                        <div id="bettingSection" class="space-y-2 mt-2">
                            <div class="grid grid-cols-3 gap-1">
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded" data-choice="1base">
                                    1루
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded" data-choice="2base">
                                    2루
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded" data-choice="3base">
                                    3루
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded" data-choice="homerun">
                                    홈런
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded" data-choice="strikeout">
                                    삼진
                                </button>
                                <button class="bet-choice-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-2 rounded" data-choice="out">
                                    아웃
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <img src="/img/menu4.png" width="50" height="50" alt="배팅금액 이미지" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">배팅포인트</p>
                        <div class="grid grid-cols-5 gap-1 mt-2">
                            <button class="bet-amount-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-1 rounded" data-amount="100">
                                100
                            </button>
                            <button class="bet-amount-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-1 rounded" data-amount="200">
                                200
                            </button>
                            <button class="bet-amount-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-1 rounded" data-amount="300">
                                300
                            </button>
                            <button class="bet-amount-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-1 rounded" data-amount="400">
                                400
                            </button>
                            <button class="bet-amount-btn bg-gray-600 hover:bg-gray-500 text-white text-xs py-2 px-1 rounded" data-amount="500">
                                500
                            </button>
                        </div>
                    </div>
                </div>

                <p class="mt-4 text-sm">보유 포인트 : <span id="userPoints" class="font-bold">0포인트</span> 
                    <span id="afterBettingPoints" class="text-yellow-400 ml-2" style="display: none;">
                        → <span class="font-bold">0포인트</span>
                    </span>
                </p>
                <p class="text-sm">예상 배당 포인트 : <span id="expectedPoints" class="font-bold">0포인트</span></p>

                <!-- 배팅 상태 표시 -->
                <div id="bettingStatusDisplay" class="mt-4 p-3 rounded-lg" style="display: none;">
                    <div class="flex items-center space-x-3">
                        <div id="bettingStatusIndicator" class="w-4 h-4 rounded-full"></div>
                        <span id="bettingStatusText" class="font-bold text-sm"></span>
                    </div>
                </div>

                <!-- 배팅 결과 표시 -->
                <div id="bettingResultDisplay" class="mt-4 p-3 rounded-lg" style="display: none;">
                    <h4 class="font-bold mb-2">배팅 결과</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-300">실제 결과:</span>
                            <span id="actualResult" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">내 예측:</span>
                            <span id="myPrediction" class="font-bold"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">결과:</span>
                            <span id="bettingResult" class="font-bold"></span>
                        </div>
                        <div id="winAmountDisplay" class="flex justify-between" style="display: none;">
                            <span class="text-gray-300">획득 포인트:</span>
                            <span id="winAmount" class="font-bold text-green-400"></span>
                        </div>
                    </div>
                </div>

                <button id="betBtn" class="flex items-center justify-center space-x-2 w-full py-3 mt-4 bg-yellow-300 text-black font-bold rounded">
                    <i class="fas fa-user-tie"></i>
                    <span>배팅하기</span>
                </button>

                <button id="resultBtn" class="flex items-center justify-center space-x-2 w-full py-3 mt-2 bg-blue-500 text-white font-bold rounded hidden">
                    <i class="fas fa-chart-line"></i>
                    <span>결과 확인</span>
                </button>
            </div>

            <!-- 승리 포인트 기부 모달 -->
            <div id="donationModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <p class="font-bold text-center text-lg mb-4">승리 포인트 기부</p>
                    <p class="text-sm text-center mb-6">축하드립니다! 승리하셨습니다.<br>획득하신 포인트 중 일부를 기부 하시겠습니까?</p>

                    <div class="flex flex-col space-y-4 mb-6" id="donationOptions">
                        <div class="grid grid-cols-2 gap-4">
                            <button class="donation-btn bg-gray-600 px-4 py-2 rounded hover:bg-gray-500" data-percent="10">10%</button>
                            <button class="donation-btn bg-gray-600 px-4 py-2 rounded hover:bg-gray-500" data-percent="15">15%</button>
                            <button class="donation-btn bg-gray-600 px-4 py-2 rounded hover:bg-gray-500" data-percent="20">20%</button>
                            <button class="donation-btn bg-gray-600 px-4 py-2 rounded hover:bg-gray-500" data-percent="30">30%</button>
                        </div>
                        <div id="donationConfirm" class="text-center hidden">
                            <p class="text-sm text-yellow-400 mt-2">선택하신 <span id="selectedPercent"></span>를 기부하시겠습니까?</p>
                            <div class="flex justify-center space-x-4 mt-4">
                                <button id="confirmYesBtn" class="bg-blue-500 px-4 py-2 rounded hover:bg-blue-600">예</button>
                                <button id="confirmNoBtn" class="bg-gray-500 px-4 py-2 rounded hover:bg-gray-600">아니오</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-around">
                        <button id="donateNoBtn" class="bg-gray-500 px-6 py-2 rounded hover:bg-gray-600">기부안함</button>
                    </div>
                </div>
            </div>

            <!-- 패배 결과 모달 -->
            <div id="loseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fas fa-times-circle text-red-500 text-5xl mb-4"></i>
                        <p class="font-bold text-xl mb-2">패배</p>
                        <p class="text-sm text-gray-300">아쉽게도 패배하였습니다.<br>다음 기회를 노려보세요!</p>
                    </div>
                    <button id="loseConfirmBtn" class="w-full bg-blue-500 px-6 py-2 rounded hover:bg-blue-600">
                        확인
                    </button>
                </div>
            </div>

            <!-- 게스트 승리 모달 -->
            <div id="guestWinModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fas fa-trophy text-yellow-500 text-5xl mb-4"></i>
                        <p class="font-bold text-xl mb-2">축하합니다!</p>
                        <p class="text-sm text-gray-300">승리하셨습니다!</p>
                    </div>
                    <button id="guestWinConfirmBtn" class="w-full bg-blue-500 px-6 py-2 rounded hover:bg-blue-600">
                        확인
                    </button>
                </div>
            </div>

            <!-- 기부 완료 모달 -->
            <div id="donationCompleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <div class="text-center mb-6">
                        <i class="fas fa-heart text-red-500 text-5xl mb-4"></i>
                        <p class="font-bold text-xl mb-2">기부 완료</p>
                        <p class="text-sm text-gray-300" id="donationCompleteMessage"></p>
                    </div>
                    <button id="donationCompleteBtn" class="w-full bg-blue-500 px-6 py-2 rounded hover:bg-blue-600">
                        확인
                    </button>
                </div>
            </div>

            <!-- 게스트 알림 모달 -->
            <div id="guestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                    <div class="text-center">
                        <p class="text-lg font-bold mb-4 text-red-500">게스트는 해당사항이 아닙니다.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 하단 네비게이션 -->
    <nav class="w-full bg-black text-white py-3 border-t border-gray-700">
        <div class="flex justify-evenly">
            <div class="text-center cursor-pointer" onclick="location.href='invite.html'">
                <i class="fas fa-user-plus text-2xl"></i>
                <p class="text-[0.4rem]">초대</p>
            </div>
            <div class="text-center cursor-pointer" onclick="checkAttendance()">
                <i class="fas fa-calendar-alt text-2xl"></i>
                <p class="text-[0.4rem]">출석부</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='board.html'">
                <i class="fas fa-clipboard text-2xl"></i>
                <p class="text-[0.4rem]">게시판</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='charge.html'">
                <i class="fas fa-coins text-2xl"></i>
                <p class="text-[0.4rem]">포인트충전</p>
            </div>
        </div>
    </nav>

    <script>
        // 전역 변수로 currentUser와 isBetting 선언
        let currentUser = null;
        let isBetting = false;
        let currentWinPoints = 0; // 현재 승리 포인트 저장용



        // 페이지 로드 시 사용자 정보 가져오기
        document.addEventListener('DOMContentLoaded', async () => {
            // localStorage에서 사용자 정보 확인
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    
                    // 사용자 이름 표시 (게스트 여부에 따라 다르게 표시)
                    const displayName = currentUser.isGuest ? '게스트' : `${currentUser.name}님`;
                    document.getElementById('userNameDisplay').textContent = `${displayName} 환영합니다!`;
                    
                    // 포인트 표시
                    document.getElementById('userPoints').textContent = `${currentUser.points}`;
                    
                    // 로그인/로그아웃 버튼 표시 설정
                    document.getElementById('loginButton').style.display = 'none';
                    document.getElementById('logoutButton').style.display = 'block';
                } catch (error) {
                    console.error('사용자 정보 파싱 오류:', error);
                    localStorage.removeItem('currentUser');
                    currentUser = null;
                }
            }
            
            // 로그인 상태에 관계없이 기본 UI 설정
            if (!currentUser) {
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('logoutButton').style.display = 'none';
            }

            // 오늘의 경기 로드 (로그인 상태에 관계없이)
            await loadDailyGames();
            
            // 버튼 이벤트 리스너 설정
            setupButtonEventListeners();
            
            // 배팅 상태 확인 시작
            checkBettingStatus();
            // 배팅 상태 주기적 확인 (0.1초마다 - 실시간)
            setInterval(checkBettingStatus, 100);
        });

        // 로그아웃 함수
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }

        // 배팅 처리 함수
        function handleBetting() {
            // 로그인 상태 확인
            if (!currentUser || !currentUser.userId) {
                alert('로그인이 필요한 서비스입니다.');
                window.location.href = '/login.html';
                return;
            }

            if (isBetting) return; // 이미 배팅 중이면 리턴

            // 선택된 배팅 유형 확인
            const selectedBet = document.querySelector('input[name="betChoice"]:checked');
            if (!selectedBet) {
                alert('배팅 유형을 선택해주세요.');
                return;
            }

            const betAmount = parseInt(document.getElementById('betAmount').value);
            if (!betAmount || betAmount < 100) {
                alert('배팅 포인트를 입력해주세요. (최소 100포인트)');
                return;
            }
            
            // 보유 포인트 확인
            if (currentUser.points < betAmount) {
                alert('보유 포인트가 부족합니다.');
                return;
            }

            // 현재 날짜와 선택된 경기 정보 가져오기
            const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const selectedGame = getSelectedGame();
            
            if (!selectedGame) {
                alert('경기를 선택해주세요.');
                return;
            }

            // 서버로 배팅 데이터 전송
            fetch('/api/betting/bet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: today,
                    gameNumber: selectedGame.gameNumber,
                    memberId: currentUser.userId,
                    memberName: currentUser.name,
                    betChoice: selectedBet.value,
                    betAmount: betAmount
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // 배팅 포인트 차감
                    currentUser.points -= betAmount;
                    document.getElementById('userPoints').textContent = `${currentUser.points}`;
                    
                    // localStorage 업데이트
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    // 배팅 버튼 숨기고 결과 버튼 표시
                    document.getElementById('betBtn').style.display = 'none';
                    document.getElementById('resultBtn').style.display = 'block';
                    
                    // 배팅 중 상태로 변경
                    isBetting = true;
                    
                    alert('배팅이 완료되었습니다!');
                } else {
                    alert('배팅 실패: ' + data.message);
                }
            })
            .catch(error => {
                console.error('배팅 오류:', error);
                alert('배팅 중 오류가 발생했습니다.');
            });
        }

        // 선택된 경기 정보 가져오기
        function getSelectedGame() {
            const selectedGameElement = document.querySelector('.game-item.selected');
            if (selectedGameElement) {
                const gameNumber = selectedGameElement.dataset.gameNumber;
                const homeTeam = selectedGameElement.dataset.homeTeam;
                const awayTeam = selectedGameElement.dataset.awayTeam;
                return { gameNumber, homeTeam, awayTeam };
            }
            return null;
        }

        // 배팅 결과 표시 함수
        async function showBettingResult() {
            if (!isBetting) return;
            
            try {
                const selectedGame = getSelectedGame();
                if (!selectedGame) {
                    alert('선택된 경기가 없습니다.');
                    return;
                }

                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                
                // 서버에서 배팅 결과 조회
                const response = await fetch(`/api/betting/results?date=${today}&gameNumber=${selectedGame.gameNumber}`);
                const data = await response.json();
                
                // 사용자의 배팅 결과 찾기
                const myResult = data.bets.find(b => b.memberId === currentUser.userId);
                
                if (myResult) {
                    if (myResult.isWinner) {
                        // 승리 시 포인트 추가
                        currentUser.points += myResult.winAmount;
                        document.getElementById('userPoints').textContent = `${currentUser.points}`;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        if (currentUser.isGuest) {
                            showGuestWinModal();
                        } else {
                            showDonationModal();
                            document.getElementById('donationOptions').style.display = 'block';
                        }
                    } else {
                        showLoseModal();
                    }
                } else {
                    alert('배팅 내역이 없습니다.');
                }

                // 배팅 버튼 복원
                document.getElementById('betBtn').style.display = 'block';
                document.getElementById('resultBtn').style.display = 'none';
                
                // 배팅 상태 초기화
                isBetting = false;

                // 예상 배당금 업데이트
                updateExpectedPoints();
            } catch (error) {
                console.error('배팅 결과 처리 중 오류:', error);
                alert('배팅 결과 처리 중 오류가 발생했습니다.');
            }
        }

        // 예상 배당금 계산 및 표시 함수
        function updateExpectedPoints() {
            const selectedBet = document.querySelector('input[name="betChoice"]:checked');
            const bettingPoints = parseInt(document.getElementById('betAmount').value) || 0;
            
            if (!selectedBet || bettingPoints === 0) {
                document.getElementById('expectedPoints').textContent = '0';
                const afterBettingSpan = document.getElementById('afterBettingPoints');
                afterBettingSpan.style.display = 'none';
                return;
            }
            
            // 간단한 예상 배당금 계산 (배팅 포인트의 2배)
            const expectedWinPoints = bettingPoints * 2;
            
            // 예상 배당금 표시
            document.getElementById('expectedPoints').textContent = `${expectedWinPoints}`;
            
            // 배팅 후 예상 포인트 표시
            const afterBettingSpan = document.getElementById('afterBettingPoints');
            afterBettingSpan.style.display = 'inline';
            afterBettingSpan.querySelector('span').textContent = `${currentUser.points - bettingPoints}`;
        }

        // 배팅 유형 선택 또는 배팅 포인트 변경 시 예상 배당금 업데이트
        document.querySelectorAll('input[name="betChoice"]').forEach(radio => {
            radio.addEventListener('change', updateExpectedPoints);
        });
        document.getElementById('betAmount').addEventListener('input', updateExpectedPoints);

        // 모달 관련 함수들은 그대로 유지
        function showGuestWinModal() {
            document.getElementById('guestWinModal').style.display = 'flex';
        }

        function showDonationModal() {
            document.getElementById('donationModal').style.display = 'flex';
        }

        function showLoseModal() {
            document.getElementById('loseModal').style.display = 'flex';
        }

        // 모달 닫기 이벤트 리스너들
        document.getElementById('donateNoBtn').addEventListener('click', () => {
            document.getElementById('donationModal').style.display = 'none';
            // 기부하지 않을 경우 서버에 최종 포인트만 업데이트
            if (!currentUser.isGuest) {
                updateServerPoints(currentUser.points);
            }
        });

        document.getElementById('loseConfirmBtn').addEventListener('click', () => {
            document.getElementById('loseModal').style.display = 'none';
        });

        document.getElementById('guestWinConfirmBtn').addEventListener('click', () => {
            document.getElementById('guestWinModal').style.display = 'none';
        });

        // 서버 포인트 업데이트 함수
        async function updateServerPoints(points) {
            try {
                const response = await fetch('/api/update-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        points: points
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    console.error('포인트 업데이트 실패:', data.message);
                }
            } catch (error) {
                console.error('포인트 업데이트 오류:', error);
            }
        }

        // 기부 처리 함수
        async function handleDonation(percentage) {
            const donationAmount = Math.floor(currentWinPoints * (percentage / 100));
            const finalPoints = currentUser.points - donationAmount;
            
            // 서버에 기부 및 포인트 업데이트
            try {
                const response = await fetch('/api/donate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        points: finalPoints,
                        donationAmount: donationAmount
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentUser.points = finalPoints;
                    document.getElementById('userPoints').textContent = `${finalPoints}`;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    // 기부 완료 모달 표시
                    document.getElementById('donationCompleteMessage').textContent = `${donationAmount} 포인트를 기부하셨습니다. 감사합니다!`;
                    document.getElementById('donationModal').style.display = 'none';
                    document.getElementById('donationCompleteModal').style.display = 'flex';
                } else {
                    alert('기부 처리 중 오류가 발생했습니다.');
                }
            } catch (error) {
                console.error('기부 처리 오류:', error);
                alert('기부 처리 중 오류가 발생했습니다.');
            }
        }

        // 기부 버튼 이벤트 리스너
        document.querySelectorAll('.donation-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const percentage = parseInt(btn.dataset.percent);
                document.getElementById('selectedPercent').textContent = `${percentage}%`;
                document.getElementById('donationConfirm').classList.remove('hidden');
            });
        });

        // 기부 확인 버튼 이벤트 리스너
        document.getElementById('confirmYesBtn').addEventListener('click', () => {
            const percentage = parseInt(document.querySelector('.donation-btn.selected')?.dataset.percent || '10');
            handleDonation(percentage);
        });

        document.getElementById('confirmNoBtn').addEventListener('click', () => {
            document.getElementById('donationConfirm').classList.add('hidden');
        });

        // 기부 완료 모달 닫기 이벤트 리스너
        document.getElementById('donationCompleteBtn').addEventListener('click', () => {
            document.getElementById('donationCompleteModal').style.display = 'none';
        });

        // 현재 날짜 표시 함수
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            };
            const dateString = now.toLocaleDateString('ko-KR', options);
            document.getElementById('currentDate').textContent = dateString;
        }

        // 페이지 로드 시 날짜 표시
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            
            // 브라우저 종료 시 로그아웃 처리
            setupBrowserCloseLogout();
            
            // 배팅 상태 확인 시작
            startBettingStatusCheck();
        });
        
        // 브라우저 종료 시 로그아웃 처리 설정
        function setupBrowserCloseLogout() {
            // beforeunload 이벤트 (브라우저 탭/창 닫기)
            window.addEventListener('beforeunload', function(e) {
                if (currentUser && !currentUser.isGuest) {
                    // 로그아웃 API 호출
                    navigator.sendBeacon('/api/logout', JSON.stringify({
                        userId: currentUser.userId
                    }));
                }
            });
            
            // pagehide 이벤트 (페이지 숨김, 모바일에서 더 안정적)
            window.addEventListener('pagehide', function(e) {
                if (currentUser && !currentUser.isGuest) {
                    // 로그아웃 API 호출
                    navigator.sendBeacon('/api/logout', JSON.stringify({
                        userId: currentUser.userId
                    }));
                }
            });
            
            // visibilitychange 이벤트 (탭 전환 시)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden' && currentUser && !currentUser.isGuest) {
                    // 탭이 숨겨질 때도 로그아웃 처리
                    navigator.sendBeacon('/api/logout', JSON.stringify({
                        userId: currentUser.userId
                    }));
                }
            });
        }

        // 오늘의 경기 로드
        async function loadDailyGames() {
            const gameSelectionContainer = document.getElementById('gameSelectionContainer');
            
            try {
                // 로딩 상태 표시
                gameSelectionContainer.innerHTML = '<div class="text-center text-gray-400 py-2">경기 정보를 불러오는 중...</div>';
                
                // 현재 사용자 정보 확인
                let userSelection = null;
                
                if (currentUser && currentUser.userId) {
                    // 사용자의 경기 선택 정보 가져오기
                    try {
                        const selectionResponse = await fetch(`/api/game-selection/${currentUser.userId}`);
                        if (selectionResponse.ok) {
                            const selectionData = await selectionResponse.json();
                            userSelection = selectionData.selection;
                        }
                    } catch (error) {
                        console.error('사용자 선택 정보 로드 오류:', error);
                    }
                }
                
                const response = await fetch('/api/daily-games');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                gameSelectionContainer.innerHTML = '';
                
                if (data.games && data.games.length > 0) {
                    // 전체 경기 상태 확인
                    const allGamesBeforeStart = checkAllGamesStatus(data.games);
                    
                    // 선택된 경기 찾기
                    const selectedGame = data.games.find(game => userSelection && userSelection.gameNumber === game.number);
                    
                    // 드롭다운 컨테이너 생성
                    const dropdownContainer = document.createElement('div');
                    dropdownContainer.className = 'relative';
                    
                    // 선택된 경기 또는 기본 경기 표시
                    const displayGame = selectedGame || data.games[0];
                    const gameStatus = getStatusText(displayGame);
                    console.log('경기 데이터:', displayGame);
                    console.log('계산된 상태:', gameStatus);
                    const isSelectable = displayGame.isActive && gameStatus.includes('경기중');
                    const isSelected = userSelection && userSelection.gameNumber === displayGame.number;
                    
                    // 전체 경기가 경기전이면 파란색으로 표시
                    if (allGamesBeforeStart) {
                        dropdownContainer.innerHTML = `
                            <div class="game-dropdown border border-blue-500 bg-blue-900 bg-opacity-20 rounded hover:bg-blue-800 cursor-pointer" onclick="openGameModal()" style="height: 32px; display: flex; align-items: center; padding: 0 12px;">
                                <div class="flex justify-between items-center w-full">
                                    <div class="flex-1">
                                        <div class="text-xs font-bold text-blue-200">아직 경기전입니다.</div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        dropdownContainer.innerHTML = `
                            <div class="game-dropdown border border-gray-600 rounded hover:bg-gray-700 cursor-pointer ${isSelected ? 'bg-red-500 text-white' : getGameStatusClass(displayGame)}" onclick="openGameModal()" style="height: 32px; display: flex; align-items: center; padding: 0 12px;">
                                <div class="flex justify-between items-center w-full">
                                    <div class="flex-1">
                                        <div class="text-xs font-bold">${displayGame.homeTeam} vs ${displayGame.awayTeam}</div>
                                        ${isSelected ? '' : `<div class="text-xs text-gray-400">경기 ${displayGame.number} • ${getStatusText(displayGame)}</div>`}
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        ${!isSelected ? `
                                            <span class="text-xs px-2 py-1 rounded ${getStatusBadgeClass(displayGame)}">
                                                ${getGameSituationText(displayGame)}
                                            </span>
                                            ${isSelectable ? 
                                                (isSelected ? 
                                                    `<span class="text-xs bg-red-500 text-white px-2 py-1 rounded">선택중</span>` :
                                                    `<span class="text-xs text-blue-500 px-2 py-1">선택가능</span>`
                                                ) : 
                                                `<span class="text-xs text-gray-500 px-2 py-1">선택불가</span>`
                                            }
                                        ` : ''}
                                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 모달 생성
                    const modal = document.createElement('div');
                    modal.id = 'gameModal';
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
                    modal.innerHTML = `
                        <div class="bg-gray-800 rounded-lg p-4 max-w-sm w-full mx-4 max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">경기 선택</h3>
                                <button onclick="closeGameModal()" class="text-gray-400 hover:text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="space-y-2">
                                ${allGamesBeforeStart ? `
                                    <div class="p-3 border border-blue-500 bg-blue-900 bg-opacity-20 rounded-lg">
                                        <div class="text-center">
                                            <div class="text-blue-200 text-sm font-bold mb-1">아직 경기전입니다.</div>
                                            <div class="text-blue-300 text-xs">모든 경기가 시작되지 않았습니다.</div>
                                        </div>
                                    </div>
                                ` : ''}
                                ${data.games.map(game => {
                                    const gameStatus = getStatusText(game);
                                    const gameIsSelectable = game.isActive && gameStatus.includes('경기중');
                                    const gameIsSelected = userSelection && userSelection.gameNumber === game.number;
                                    
                                    return `
                                        <div class="game-option p-3 border border-gray-600 rounded-lg hover:bg-gray-700 cursor-pointer ${gameIsSelected ? 'bg-blue-900 border-blue-500' : ''}" 
                                             onclick="${gameIsSelectable ? `selectGameFromModal(${game.number}, '${game.homeTeam}', '${game.awayTeam}')` : 'alert(\'경기중인 경기만 선택할 수 있습니다.\')'}">
                                            <div class="flex justify-between items-center">
                                                <div class="flex-1">
                                                    <div class="text-sm font-bold">${game.homeTeam} vs ${game.awayTeam}</div>
                                                    <div class="text-xs text-gray-400">경기 ${game.number} • ${gameStatus}</div>

                                                </div>
                                                <div class="flex items-center space-x-2">
                                                    <span class="text-xs px-2 py-1 rounded ${getStatusBadgeClass(game)}">
                                                        ${getGameSituationText(game)}
                                                    </span>
                                                    ${gameIsSelectable ? 
                                                        (gameIsSelected ? 
                                                            `<span class="text-xs bg-red-500 text-white px-2 py-1 rounded">선택중</span>` :
                                                            `<span class="text-xs text-blue-500 px-2 py-1">선택가능</span>`
                                                        ) : 
                                                        `<span class="text-xs text-gray-500 px-2 py-1">선택불가</span>`
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    gameSelectionContainer.appendChild(dropdownContainer);
                } else {
                    // 오늘의 경기가 없을 때 모달로 알림 표시
                    showNoGamesModal();
                    gameSelectionContainer.innerHTML = '<div class="text-center text-gray-400 py-2">오늘의 경기가 없습니다.</div>';
                }
            } catch (error) {
                console.error('경기 정보 로드 중 오류:', error);
                gameSelectionContainer.innerHTML = `
                    <div class="text-center text-red-400 py-2">
                        <p class="text-xs">경기 정보를 불러오는 중 오류가 발생했습니다.</p>
                        <button onclick="loadDailyGames()" class="mt-1 px-2 py-1 bg-blue-500 rounded hover:bg-blue-600 text-xs">
                            다시 시도
                        </button>
                    </div>
                `;
            }
        }

        // 경기 상태에 따른 CSS 클래스 반환 (시간 계산된 상태 기준)
        function getGameStatusClass(game) {
            const status = getStatusText(game);
            
            if (status.includes('경기전')) {
                return 'border-yellow-500 bg-yellow-900 bg-opacity-20';
            } else if (status.includes('경기중')) {
                return 'border-blue-500 bg-blue-900 bg-opacity-20';
            } else if (status.includes('경기 끝')) {
                return 'border-gray-500 bg-gray-600';
            } else if (status === '우천취소') {
                return 'border-red-500 bg-red-900 bg-opacity-20';
            } else if (status === '경기연기') {
                return 'border-yellow-500 bg-yellow-900 bg-opacity-20';
            } else {
                return 'border-gray-600 bg-gray-700';
            }
        }

        // 게임 상황에 따른 배지 클래스 반환 (noGame 필드값 기준)
        function getStatusBadgeClass(game) {
            const situation = getGameSituationText(game);
            
            switch (situation) {
                case '정상게임':
                    return 'bg-green-500 text-white';
                case '우천취소':
                    return 'bg-red-500 text-white';
                case '경기연기':
                    return 'bg-yellow-500 text-black';
                default:
                    return 'bg-gray-500 text-white';
            }
        }

        // 경기 상태 텍스트 반환 (시간 계산된 상태)
        function getStatusText(game) {
            // 정상게임이 아닌 경우 noGame 값을 그대로 표시
            if (game.noGame !== '정상게임') {
                return game.noGame;
            }
            
            // 현재 시간
            const now = new Date();
            const currentTime = now.getHours() * 100 + now.getMinutes();
            
            // 경기 시작 시간 (HH:MM -> HHMM)
            const startTimeParts = game.startTime.split(':');
            const startTime = parseInt(startTimeParts[0]) * 100 + parseInt(startTimeParts[1]);
            
            // 경기 종료 시간 (HH:MM -> HHMM)
            const endTimeParts = game.endTime.split(':');
            let endTime = parseInt(endTimeParts[0]) * 100 + parseInt(endTimeParts[1]);
            
            // 종료 시간이 시작 시간보다 작으면 다음날 (예: 01:00)
            if (endTime < startTime) {
                endTime += 2400; // 24시간 추가
            }
            
            // 현재 시간이 시작 시간보다 작으면 경기전
            if (currentTime < startTime) {
                return `경기전 (${game.startTime})`;
            }
            // 현재 시간이 종료 시간보다 크면 경기 끝
            else if (currentTime > endTime) {
                return `경기 끝 (${game.endTime})`;
            }
            // 그 사이면 경기중
            else {
                return `경기중 (${game.startTime})`;
            }
        }

        // 전체 경기 상태 확인 함수 (1경기부터 5경기 중 하나라도 경기중이 없으면 true)
        function checkAllGamesStatus(games) {
            if (!games || games.length === 0) {
                return true; // 경기가 없으면 경기전으로 간주
            }
            
            // 1경기부터 5경기까지 확인
            for (let i = 1; i <= 5; i++) {
                const game = games.find(g => g.number === i);
                if (game) {
                    const status = getStatusText(game);
                    if (status.includes('경기중')) {
                        return false; // 하나라도 경기중이 있으면 false
                    }
                }
            }
            return true; // 모든 경기가 경기중이 아니면 true
        }

        // 게임 상황 텍스트 반환 (noGame 필드값 그대로)
        function getGameSituationText(game) {
            return game.noGame;
        }

        // 오늘의 경기가 없을 때 모달 표시
        function showNoGamesModal() {
            // 기존 모달이 있다면 제거
            const existingModal = document.getElementById('noGamesModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 새로운 모달 생성
            const modal = document.createElement('div');
            modal.id = 'noGamesModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-red-800 border-2 border-red-500 rounded-lg p-6 max-w-sm w-full mx-4 animate-pulse">
                    <div class="text-center">
                        <div class="text-red-200 text-lg font-bold mb-2">⚠️ 경고</div>
                        <div class="text-red-100 text-sm mb-4">오늘의 게임 입력이 안되어 있습니다</div>
                        <button onclick="closeNoGamesModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">
                            확인
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 3초 후 자동으로 닫기
            setTimeout(() => {
                closeNoGamesModal();
            }, 3000);
        }

        // 오늘의 경기 없음 모달 닫기
        function closeNoGamesModal() {
            const modal = document.getElementById('noGamesModal');
            if (modal) {
                modal.remove();
            }
        }



        // 모달 열기 함수
        function openGameModal() {
            const modal = document.getElementById('gameModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        // 모달 닫기 함수
        function closeGameModal() {
            const modal = document.getElementById('gameModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // 모달에서 경기 선택 함수
        async function selectGameFromModal(gameNumber, homeTeam, awayTeam) {
            // 현재 사용자 정보 확인
            if (!currentUser || !currentUser.userId) {
                alert('로그인이 필요합니다.');
                window.location.href = '/login.html';
                return;
            }
            
            try {
                const response = await fetch('/api/game-selection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        gameNumber: gameNumber
                    })
                });
                
                const data = await response.json();
                
                if (data.message) {
                    // 모달 닫기
                    closeGameModal();
                    
                    // 경기 목록 새로고침
                    await loadDailyGames();
                } else {
                    alert(data.error || '경기 선택에 실패했습니다.');
                }
            } catch (error) {
                console.error('경기 선택 오류:', error);
                alert('경기 선택 중 오류가 발생했습니다.');
            }
        }

        // 기존 경기 선택 함수 (호환성을 위해 유지)
        async function selectGame(gameNumber) {
            await selectGameFromDropdown(gameNumber, '', '');
        }

        // 전역 변수로 선택된 값들 저장
        let selectedGameType = 'batter'; // 기본값은 타자
        let selectedBetChoice = '';
        let selectedBetAmount = 0;

        // 버튼 이벤트 리스너 설정 함수
        function setupButtonEventListeners() {
            // 게임 타입 버튼 이벤트
            document.querySelectorAll('.game-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 모든 게임 타입 버튼 비활성화
                    document.querySelectorAll('.game-type-btn').forEach(b => {
                        b.classList.remove('bg-blue-500', 'active');
                        b.classList.add('bg-gray-600');
                    });
                    
                    // 선택된 버튼 활성화
                    this.classList.remove('bg-gray-600');
                    this.classList.add('bg-blue-500', 'active');
                    
                    selectedGameType = this.dataset.type;
                    console.log('선택된 게임 타입:', selectedGameType);
                });
            });

            // 배팅 선택 버튼 이벤트
            document.querySelectorAll('.bet-choice-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 모든 배팅 선택 버튼 비활성화
                    document.querySelectorAll('.bet-choice-btn').forEach(b => {
                        b.classList.remove('bg-blue-500');
                        b.classList.add('bg-gray-600');
                    });
                    
                    // 선택된 버튼 활성화
                    this.classList.remove('bg-gray-600');
                    this.classList.add('bg-blue-500');
                    
                    selectedBetChoice = this.dataset.choice;
                    console.log('선택된 배팅:', selectedBetChoice);
                });
            });

            // 배팅 포인트 버튼 이벤트
            document.querySelectorAll('.bet-amount-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // 모든 포인트 버튼 비활성화
                    document.querySelectorAll('.bet-amount-btn').forEach(b => {
                        b.classList.remove('bg-blue-500');
                        b.classList.add('bg-gray-600');
                    });
                    
                    // 선택된 버튼 활성화
                    this.classList.remove('bg-gray-600');
                    this.classList.add('bg-blue-500');
                    
                    selectedBetAmount = parseInt(this.dataset.amount);
                    console.log('선택된 포인트:', selectedBetAmount);
                });
            });

            // 배팅 버튼 이벤트
            const bettingButton = document.getElementById('betBtn');
            if (bettingButton) {
                bettingButton.addEventListener('click', submitBetting);
            }
        }
        
        // 출석체크 함수
        async function checkAttendance() {
            // 로그인 체크
            if (!currentUser || !currentUser.userId) {
                alert('로그인이 필요한 서비스입니다.');
                window.location.href = '/login.html';
                return;
            }

            // 게스트 체크
            if (currentUser.isGuest) {
                showGuestModal();
                return;
            }

            // 로그인한 회원은 출석부 화면으로 이동
            window.location.href = '/attendance.html';
        }

        // 배팅 상태 확인 함수
        async function checkBettingStatus() {
            try {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const response = await fetch(`/api/betting/status?date=${today}&gameNumber=1`);
                const data = await response.json();
                
                if (data.success) {
                    updateBettingUI(data.isActive);
                    // 배팅 결과도 함께 확인
                    checkBettingResult();
                } else {
                    updateBettingUI(false);
                }
            } catch (error) {
                console.error('배팅 상태 확인 오류:', error);
                updateBettingUI(false);
            }
        }
        
        // 배팅 결과 확인 함수
        async function checkBettingResult() {
            if (!currentUser || !currentUser.userId) return;
            
            try {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const response = await fetch(`/api/betting/results?date=${today}&gameNumber=1`);
                const data = await response.json();
                
                if (data.success && data.session && data.session.isProcessed) {
                    displayBettingResult(data.session);
                } else {
                    // 결과가 아직 처리되지 않았으면 결과 표시 숨기기
                    document.getElementById('bettingResultDisplay').style.display = 'none';
                }
            } catch (error) {
                console.error('배팅 결과 확인 오류:', error);
            }
        }
        
        // 배팅 결과 표시 함수
        function displayBettingResult(session) {
            const resultDisplay = document.getElementById('bettingResultDisplay');
            const actualResult = document.getElementById('actualResult');
            const myPrediction = document.getElementById('myPrediction');
            const bettingResult = document.getElementById('bettingResult');
            const winAmountDisplay = document.getElementById('winAmountDisplay');
            const winAmount = document.getElementById('winAmount');
            
            // 실제 결과 표시
            const resultLabels = {
                '1base': '1루',
                '2base': '2루', 
                '3base': '3루',
                'homerun': '홈런',
                'strikeout': '삼진',
                'out': '아웃'
            };
            
            actualResult.textContent = resultLabels[session.result] || session.result;
            
            // 내 예측 찾기
            const myBet = currentUser.bettingHistory ? 
                currentUser.bettingHistory.find(bet => 
                    bet.date === session.date && bet.gameNumber === session.gameNumber
                ) : null;
            
            if (myBet) {
                myPrediction.textContent = resultLabels[myBet.prediction] || myBet.prediction;
                
                // 승리 여부 확인
                const isWinner = myBet.prediction === session.result;
                bettingResult.textContent = isWinner ? '승리!' : '패배';
                bettingResult.className = isWinner ? 'font-bold text-green-400' : 'font-bold text-red-400';
                
                if (isWinner) {
                    const winPoints = myBet.points * 2;
                    winAmount.textContent = `${winPoints}포인트`;
                    winAmountDisplay.style.display = 'flex';
                    
                    // 포인트 업데이트
                    currentUser.points += winPoints;
                    document.getElementById('userPoints').textContent = `${currentUser.points}포인트`;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                } else {
                    winAmountDisplay.style.display = 'none';
                }
            } else {
                myPrediction.textContent = '배팅 없음';
                bettingResult.textContent = '배팅 없음';
                bettingResult.className = 'font-bold text-gray-400';
                winAmountDisplay.style.display = 'none';
            }
            
            resultDisplay.style.display = 'block';
        }
        
        // 배팅 UI 업데이트 함수
        function updateBettingUI(isActive) {
            const statusDisplay = document.getElementById('bettingStatusDisplay');
            const statusIndicator = document.getElementById('bettingStatusIndicator');
            const statusText = document.getElementById('bettingStatusText');
            const betBtn = document.getElementById('betBtn');
            const gameTypeBtns = document.querySelectorAll('.game-type-btn');
            const betChoiceBtns = document.querySelectorAll('.bet-choice-btn');
            const betAmountBtns = document.querySelectorAll('.bet-amount-btn');
            
            if (isActive) {
                // 배팅 활성화 상태
                statusDisplay.style.display = 'block';
                statusIndicator.className = 'w-4 h-4 rounded-full bg-green-500';
                statusText.textContent = '배팅 가능';
                statusText.className = 'font-bold text-sm text-green-400';
                
                // 배팅 버튼 활성화
                betBtn.disabled = false;
                betBtn.classList.remove('bg-gray-500');
                betBtn.classList.add('bg-yellow-300');
                betBtn.innerHTML = '<i class="fas fa-user-tie"></i><span>배팅하기</span>';
                
                // 모든 선택 버튼 활성화
                gameTypeBtns.forEach(btn => {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
                betChoiceBtns.forEach(btn => {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
                betAmountBtns.forEach(btn => {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                });
            } else {
                // 배팅 비활성화 상태
                statusDisplay.style.display = 'block';
                statusIndicator.className = 'w-4 h-4 rounded-full bg-red-500';
                statusText.textContent = '배팅 대기중 (관리자가 배팅을 시작할 때까지 기다려주세요)';
                statusText.className = 'font-bold text-sm text-red-400';
                
                // 배팅 버튼 비활성화
                betBtn.disabled = true;
                betBtn.classList.remove('bg-yellow-300');
                betBtn.classList.add('bg-gray-500');
                betBtn.innerHTML = '<i class="fas fa-clock"></i><span>배팅 대기중...</span>';
                
                // 모든 선택 버튼 비활성화 (disabled 제거, 시각적 비활성화만)
                gameTypeBtns.forEach(btn => {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                betChoiceBtns.forEach(btn => {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
                betAmountBtns.forEach(btn => {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                });
            }
        }
        
        // 배팅 상태 주기적 확인 시작
        function startBettingStatusCheck() {
            // 초기 확인
            checkBettingStatus();
            
            // 1초마다 상태 확인
            setInterval(checkBettingStatus, 1000);
        }
        
        // 배팅 제출 함수
        async function submitBetting() {
            if (!currentUser || !currentUser.userId) {
                alert('로그인이 필요한 서비스입니다.');
                window.location.href = '/login.html';
                return;
            }
            
            // 선택된 값들 확인
            if (!selectedGameType || !selectedBetChoice || !selectedBetAmount) {
                alert('게임 타입, 배팅 선택, 배팅 포인트를 선택해주세요.');
                return;
            }
            
            if (currentUser.points < selectedBetAmount) {
                alert('포인트가 부족합니다.');
                return;
            }
            
            // 배팅 상태 확인
            try {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const statusResponse = await fetch(`/api/betting/status?date=${today}&gameNumber=1`);
                const statusData = await statusResponse.json();
                
                if (!statusData.success || !statusData.isActive) {
                    alert('현재 배팅이 비활성화되어 있습니다. 관리자가 배팅을 시작할 때까지 기다려주세요.');
                    return;
                }
            } catch (error) {
                console.error('배팅 상태 확인 오류:', error);
                alert('배팅 상태를 확인할 수 없습니다.');
                return;
            }
            
            try {
                const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const response = await fetch('/api/betting/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        gameType: selectedGameType,
                        prediction: selectedBetChoice,
                        points: selectedBetAmount,
                        date: today,
                        gameNumber: 1
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // 포인트 업데이트
                    currentUser.points = result.remainingPoints;
                    document.getElementById('userPoints').textContent = `${result.remainingPoints}포인트`;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    alert('배팅이 완료되었습니다!');
                    
                    // 배팅 버튼 비활성화 (한 번 배팅하면 더 이상 배팅 불가)
                    const betBtn = document.getElementById('betBtn');
                    betBtn.disabled = true;
                    betBtn.classList.remove('bg-yellow-300');
                    betBtn.classList.add('bg-gray-500');
                    betBtn.innerHTML = '<i class="fas fa-check"></i><span>배팅 완료</span>';
                    
                    // 모든 선택 버튼 비활성화 (시각적만)
                    document.querySelectorAll('.game-type-btn, .bet-choice-btn, .bet-amount-btn').forEach(btn => {
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                } else {
                    alert('배팅 실패: ' + result.message);
                }
            } catch (error) {
                console.error('배팅 제출 오류:', error);
                alert('배팅 중 오류가 발생했습니다.');
            }
        }
        
        // 게스트 모달 표시 함수
        function showGuestModal() {
            document.getElementById('guestModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('guestModal').style.display = 'none';
            }, 2000);
        }
    </script>

    <style>
        .date-display {
            font-size: 0.42em;  /* 0.84em에서 50% 감소 */
            color: #666;
            margin: 10px 0;
            text-align: center;
        }
        
        /* 가로 스크롤바 스타일링 */
        #gameSelectionContainer::-webkit-scrollbar {
            height: 6px;
        }
        
        #gameSelectionContainer::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 3px;
        }
        
        #gameSelectionContainer::-webkit-scrollbar-thumb {
            background: #6B7280;
            border-radius: 3px;
        }
        
        #gameSelectionContainer::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }
        
        /* Firefox 가로 스크롤바 스타일링 */
        #gameSelectionContainer {
            scrollbar-width: thin;
            scrollbar-color: #6B7280 #374151;
        }
        
        /* 경기 아이템 스타일링 */
        .game-item {
            min-width: 140px;
            flex-shrink: 0;
        }
    </style>

</body>
</html> 