<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포인트 충전</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        console.warn = function() {};
        console.error = function() {};
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- 상단 네비게이션 -->
    <nav class="bg-gray-800 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">포인트 충전</h1>
                <span id="userNameDisplay" class="text-gray-300">로딩 중...</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="currentPoints" class="text-yellow-400 font-bold">0P</span>
                <button id="homeButton" onclick="window.location.href='index.html'" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-home mr-2"></i>홈으로
                </button>
                <button id="loginButton" onclick="window.location.href='login.html'" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>로그인
                </button>
            </div>
        </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <div class="container mx-auto px-4 py-8">
        <!-- 포인트 충전 안내 -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">
                <i class="fas fa-coins text-yellow-400 mr-2"></i>
                포인트 충전
            </h2>
            <p class="text-gray-300 text-center mb-6">
                광고 시청을 통해 포인트를 충전하세요.<br>
                <span class="text-red-400 font-bold">500포인트 이상 보유 시 충전이 제한됩니다.</span>
            </p>
        </div>

        <!-- 광고 옵션 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div id="ad10" class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-6 text-center cursor-pointer hover:from-blue-700 hover:to-blue-800 transition-all duration-300">
                <div class="text-4xl mb-4">
                    <i class="fas fa-play-circle"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">10초 광고</h3>
                <p class="text-2xl font-bold text-yellow-400 mb-2">1,000P</p>
                <p class="text-sm text-gray-300">간단한 광고 시청</p>
            </div>

            <div id="ad20" class="bg-gradient-to-br from-green-600 to-green-700 rounded-lg p-6 text-center cursor-pointer hover:from-green-700 hover:to-green-800 transition-all duration-300">
                <div class="text-4xl mb-4">
                    <i class="fas fa-play-circle"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">20초 광고</h3>
                <p class="text-2xl font-bold text-yellow-400 mb-2">2,000P</p>
                <p class="text-sm text-gray-300">일반 광고 시청</p>
            </div>

            <div id="ad30" class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-6 text-center cursor-pointer hover:from-purple-700 hover:to-purple-800 transition-all duration-300">
                <div class="text-4xl mb-4">
                    <i class="fas fa-play-circle"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">30초 광고</h3>
                <p class="text-2xl font-bold text-yellow-400 mb-2">3,000P</p>
                <p class="text-sm text-gray-300">긴 광고 시청</p>
            </div>
        </div>

        <!-- 안내 메시지 -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                이용 안내
            </h3>
            <ul class="text-gray-300 space-y-2">
                <li><i class="fas fa-check text-green-400 mr-2"></i>광고 시청 완료 후 즉시 포인트가 지급됩니다.</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>500포인트 이상 보유 시 충전이 제한됩니다.</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>로그인 후 이용 가능합니다.</li>
            </ul>
        </div>
    </div>

    <!-- 광고 모달 -->
    <div id="adModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <h3 id="adTitle" class="text-xl font-bold mb-4">광고 시청</h3>
                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                    <video id="adVideo" class="w-full rounded" controls>
                        <source src="" type="video/mp4">
                        브라우저가 비디오를 지원하지 않습니다.
                    </video>
                </div>
                <div class="text-center mb-4">
                    <p class="text-lg">남은 시간: <span id="countdown" class="font-bold text-yellow-400">0</span>초</p>
                </div>
                <div class="bg-gray-700 rounded-lg p-4">
                    <p class="text-sm text-gray-300">
                        광고 시청이 완료되면 자동으로 포인트가 지급됩니다.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 500포인트 초과 경고 모달 -->
    <div id="warningModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-red-800 rounded-lg p-6 max-w-md w-full mx-4 text-center">
            <div class="text-4xl mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
            </div>
            <h3 class="text-xl font-bold mb-4 text-white">포인트 충전 제한</h3>
            <p class="text-gray-200 mb-6">
                현재 보유 포인트가 500을 초과하여<br>
                포인트 충전이 제한됩니다.
            </p>
            <div class="text-sm text-gray-300">
                <p>5초 후 메인 페이지로 이동합니다...</p>
                <p id="countdownText" class="text-yellow-400 font-bold text-lg mt-2">5</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let adPlaying = false;

        // 광고 옵션 설정
        const adOptions = {
            10: { points: 1000, videoUrl: 'https://sample-videos.com/zip/10/mp4/SampleVideo_1280x720_1mb.mp4', title: '10초 광고' },
            20: { points: 2000, videoUrl: 'https://sample-videos.com/zip/20/mp4/SampleVideo_1280x720_2mb.mp4', title: '20초 광고' },
            30: { points: 3000, videoUrl: 'https://sample-videos.com/zip/30/mp4/SampleVideo_1280x720_5mb.mp4', title: '30초 광고' }
        };

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    
                    // 사용자 정보 표시
                    document.getElementById('userNameDisplay').textContent = `${currentUser.name}님`;
                    document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                    document.getElementById('loginButton').style.display = 'none';
                    document.getElementById('homeButton').style.display = 'block';

                    // 500포인트 초과 체크
                    if (currentUser.points > 500) {
                        showWarningModal();
                        return;
                    }

                    // 광고 버튼 활성화
                    enableAdButtons();
                } else {
                    // 로그인하지 않은 사용자
                    document.getElementById('userNameDisplay').textContent = '게스트 사용자';
                    document.getElementById('currentPoints').textContent = '0P';
                    document.getElementById('loginButton').style.display = 'block';
                    document.getElementById('homeButton').style.display = 'none';
                    
                    // 광고 버튼 비활성화
                    disableAdButtons();
                }
            } catch (error) {
                console.error('사용자 정보 로드 실패:', error);
                disableAdButtons();
            }
        });

        // 광고 버튼 활성화
        function enableAdButtons() {
            document.getElementById('ad10').onclick = () => watchAd(10);
            document.getElementById('ad20').onclick = () => watchAd(20);
            document.getElementById('ad30').onclick = () => watchAd(30);
        }

        // 광고 버튼 비활성화
        function disableAdButtons() {
            const adButtons = document.querySelectorAll('#ad10, #ad20, #ad30');
            adButtons.forEach(btn => {
                btn.onclick = null;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('cursor-pointer');
            });
        }

        // 500포인트 초과 경고 모달 표시
        function showWarningModal() {
            const modal = document.getElementById('warningModal');
            modal.style.display = 'flex';
            
            let countdown = 5;
            const countdownElement = document.getElementById('countdownText');
            
            const timer = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    window.location.href = 'index.html';
                }
            }, 1000);
        }

        // 광고 시청
        async function watchAd(duration) {
            if (adPlaying) return;
            if (!currentUser) {
                alert('로그인 후 광고 시청을 이용해주세요.');
                window.location.href = 'login.html';
                return;
            }

            // 500포인트 초과 체크
            if (currentUser.points > 500) {
                alert('포인트가 500을 초과하여 광고 시청이 제한됩니다.');
                return;
            }

            adPlaying = true;
            const points = adOptions[duration].points;
            const videoUrl = adOptions[duration].videoUrl;
            const title = adOptions[duration].title;

            // 광고 모달 표시
            const modal = document.getElementById('adModal');
            const adTitle = document.getElementById('adTitle');
            const adVideo = document.getElementById('adVideo');
            const countdown = document.getElementById('countdown');
            
            adTitle.textContent = title;
            modal.style.display = 'flex';
            countdown.textContent = duration;

            // 비디오 설정
            adVideo.src = videoUrl;
            adVideo.currentTime = 0;
            
            // 비디오 로드 후 재생
            adVideo.onloadeddata = function() {
                adVideo.play().catch(error => {
                    console.log('자동 재생 실패:', error);
                });
            };

            // 카운트다운
            let timeLeft = duration;
            const timer = setInterval(() => {
                timeLeft--;
                countdown.textContent = timeLeft > 0 ? timeLeft : 0;
                if (timeLeft <= 0) clearInterval(timer);
            }, 1000);

            // 광고 완료 처리
            let finished = false;
            async function finishAd() {
                if (finished) return;
                finished = true;
                
                clearInterval(timer);
                adVideo.pause();
                adVideo.src = '';
                modal.style.display = 'none';
                adPlaying = false;

                // 포인트 지급 처리
                try {
                    const response = await fetch('/api/update-points', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.userId, 
                            addPoints: points
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // 서버 업데이트 성공
                            currentUser.points = data.points;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                            
                            alert(`${duration}초 광고 시청 완료!\n${points.toLocaleString()}포인트가 지급되었습니다.`);
                            
                            // 500포인트 초과 체크
                            if (currentUser.points > 500) {
                                showWarningModal();
                            }
                        } else {
                            alert('포인트 지급에 실패했습니다. 다시 시도해주세요.');
                        }
                    } else {
                        alert('서버 연결에 실패했습니다. 다시 시도해주세요.');
                    }
                } catch (error) {
                    console.error('포인트 지급 오류:', error);
                    alert('포인트 지급 중 오류가 발생했습니다. 다시 시도해주세요.');
                }
            }

            // 비디오 종료 이벤트
            adVideo.onended = finishAd;
            
            // 백업 타이머
            setTimeout(finishAd, duration * 1000);
        }
    </script>
</body>
</html> 