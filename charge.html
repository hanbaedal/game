<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ν¬μΈνΈ μ¶©μ „</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS CDN κ²½κ³  μ¨κΈ°κΈ°
        console.warn = function() {};
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body class="bg-black text-white">
    <!-- μƒλ‹¨ λ„¤λΉ„κ²μ΄μ… -->
    <header class="flex justify-between items-center px-6 py-4 border-b border-gray-700">
        <div class="flex items-center space-x-3">
            <a href="index.html" class="cursor-pointer">
                <img src="/img/logo.png" width="40" height="8" alt="PPADUN λ΅κ³ ">
            </a>
            <span id="userNameDisplay" class="text-xs font-bold text-blue-200"></span>
        </div>
        <div class="flex space-x-6">
            <div id="loginButton" class="text-center cursor-pointer" onclick="location.href='/login.html'" style="display: block;">
                <i class="fas fa-sign-in-alt text-2xl"></i>
                <p class="text-sm mt-1">λ΅κ·ΈμΈ</p>
            </div>
            <div id="homeButton" class="text-center cursor-pointer" onclick="location.href='/'" style="display: none;">
                <i class="fas fa-home text-2xl"></i>
                <p class="text-[0.4rem] mt-1">ν™</p>
            </div>
        </div>
    </header>

    <!-- λ©”μΈ μ»¨ν…μ΄λ„ -->
    <main class="p-4">
        <div class="bg-gray-800 max-w-lg mx-auto p-6 rounded-lg">
            <h2 class="text-xl font-bold mb-6">ν¬μΈνΈ μ¶©μ „</h2>
            
            <!-- ν„μ¬ ν¬μΈνΈ -->
            <div class="bg-gray-700 p-4 rounded-lg mb-6">
                <h3 class="text-sm font-bold mb-2">ν„μ¬ λ³΄μ  ν¬μΈνΈ</h3>
                <p class="text-2xl font-bold" id="currentPoints">0P</p>
            </div>



            <!-- λ™μμƒ κ΄‘κ³  λ©”λ‰΄ -->
            <div class="space-y-4 mb-6">
                <h3 class="text-sm font-bold">λ™μμƒ κ΄‘κ³  μ‹μ²­</h3>
                <div class="grid grid-cols-1 gap-4" id="adMenuList">
                    <!-- κ΄‘κ³  λ©”λ‰΄κ°€ JSλ΅ λ™μ μΌλ΅ λ λ”λ§λ¨ -->
                </div>
            </div>


        </div>
    </main>

    <!-- ν•λ‹¨ λ„¤λΉ„κ²μ΄μ… -->
    <nav class="w-full bg-black text-white py-3 border-t border-gray-700">
        <div class="flex justify-evenly">
            <div class="text-center cursor-pointer" onclick="location.href='invite.html'">
                <i class="fas fa-user-plus text-2xl"></i>
                <p class="text-[0.4rem]">μ΄λ€</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='attendance.html'">
                <i class="fas fa-calendar-alt text-2xl"></i>
                <p class="text-[0.4rem]">μ¶μ„λ¶€</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='board.html'">
                <i class="fas fa-clipboard text-2xl"></i>
                <p class="text-[0.4rem]">κ²μ‹ν</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='charge.html'">
                <i class="fas fa-coins text-2xl"></i>
                <p class="text-[0.4rem]">ν¬μΈνΈμ¶©μ „</p>
            </div>
        </div>
    </nav>

    <!-- κ²μ¤νΈ μ•λ¦Ό λ¨λ‹¬ -->
    <div id="guestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
            <div class="text-center">
                <p class="text-lg font-bold mb-4 text-red-500">κ²μ¤νΈλ” ν•΄λ‹Ήμ‚¬ν•­μ΄ μ•„λ‹™λ‹λ‹¤.</p>
            </div>
        </div>
    </div>



    <!-- λ™μμƒ κ΄‘κ³  λ¨λ‹¬ -->
    <div id="adModal" class="fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full mx-4">
            <div class="text-center">
                <h3 class="text-xl font-bold mb-4" id="adTitle">λ™μμƒ κ΄‘κ³ </h3>
                <div class="bg-gray-900 p-4 rounded-lg mb-4">
                    <div id="adVideo" style="width: 480px; height: 270px; margin: 0 auto; border-radius: 8px; overflow: hidden;">
                        <video id="adVideoElement" style="width: 100%; height: 100%; object-fit: cover;" controls>
                            <source src="" type="video/mp4">
                            λΈλΌμ°μ €κ°€ λΉ„λ””μ¤λ¥Ό μ§€μ›ν•μ§€ μ•μµλ‹λ‹¤.
                        </video>
                    </div>
                    <p class="text-sm text-gray-500 mt-2" id="adTimer">λ‚¨μ€ μ‹κ°„: <span id="countdown">0</span>μ΄</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        const adOptions = [
            { 
                duration: 10, 
                points: 1000, 
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4',
                title: '10μ΄ κ΄‘κ³ '
            },
            { 
                duration: 20, 
                points: 2000, 
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
                title: '20μ΄ κ΄‘κ³ '
            },
            { 
                duration: 30, 
                points: 3000, 
                videoUrl: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',
                title: '30μ΄ κ΄‘κ³ '
            }
        ];

        // κ΄‘κ³  λ©”λ‰΄ λ λ”λ§
        function renderAdMenu() {
            const adMenuList = document.getElementById('adMenuList');
            adMenuList.innerHTML = '';
            
            // ν¬μΈνΈκ°€ 500 μ΄ν•μΈμ§€ ν™•μΈ
            const userPoints = currentUser ? currentUser.points : 0;
            const canCharge = userPoints <= 500;
            
            adOptions.forEach(opt => {
                // 10λ¶„ μ ν• μ κ±° - 500ν¬μΈνΈ μ΄ν•μΌ λ•λ§ μ ν•
                const canWatch = canCharge;
                
                console.log(`π” κ΄‘κ³  ${opt.title}: ν¬μΈνΈ=${userPoints}, canCharge=${canCharge}, canWatch=${canWatch}`);
                
                const div = document.createElement('div');
                div.className = 'bg-gray-700 p-4 rounded-lg text-center mb-2' + (canWatch ? ' cursor-pointer hover:bg-gray-600' : ' opacity-50 cursor-not-allowed');
                div.innerHTML = `
                    <p class="text-lg font-bold">${opt.title}</p>
                    <p class="text-sm text-blue-400">${opt.points.toLocaleString()}P νλ“</p>
                    <p class="text-xs text-gray-400">${opt.duration}μ΄</p>
                    ${!canCharge ? '<p class="text-xs text-red-400 mt-1">ν¬μΈνΈ 500 μ΄ν•μΌ λ•λ§ μ¶©μ „ κ°€λ¥</p>' : ''}
                `;
                if (canWatch) {
                    div.onclick = () => watchAd(opt.duration, opt.points, opt.videoUrl, opt.title);
                }
                adMenuList.appendChild(div);
            });
        }

        // νμ΄μ§€ λ΅λ“ μ‹ μ‚¬μ©μ μ •λ³΄ κ°€μ Έμ¤κΈ°
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    
                    // κ²μ¤νΈ μ ν• μ™„μ „ μ κ±° - λ¨λ“  μ‚¬μ©μκ°€ ν¬μΈνΈ μ¶©μ „ κ°€λ¥
                    document.getElementById('userNameDisplay').textContent = `${currentUser.name}λ‹ ν™μν•©λ‹λ‹¤!`;
                    document.getElementById('loginButton').style.display = 'none';
                    document.getElementById('homeButton').style.display = 'block';
                    document.getElementById('currentPoints').textContent = `${currentUser.points}P`;

                    // λ³΄μ  ν¬μΈνΈκ°€ 500μ„ μ΄κ³Όν•λ” κ²½μ° μ•λ‚΄ λ©”μ‹μ§€ ν‘μ‹
                    if (currentUser.points > 500) {
                        showPointsExceedMessage();
                    }
                } else {
                    // λ΅κ·ΈμΈν•μ§€ μ•μ€ μ‚¬μ©μλ„ ν¬μΈνΈ μ¶©μ „ νμ΄μ§€ μ ‘κ·Ό κ°€λ¥
                    document.getElementById('userNameDisplay').textContent = 'κ²μ¤νΈ μ‚¬μ©μ';
                    document.getElementById('loginButton').style.display = 'block';
                    document.getElementById('homeButton').style.display = 'none';
                    document.getElementById('currentPoints').textContent = '0P';
                }
                renderAdMenu(); // νμ΄μ§€ λ΅λ“ μ‹ κ΄‘κ³  λ©”λ‰΄ λ λ”λ§
            } catch (error) {
                console.error('μ‚¬μ©μ μ •λ³΄ λ΅λ“ μ‹¤ν¨:', error);
                // μ¤λ¥ λ°μƒ μ‹μ—λ„ κ²μ¤νΈ λ¨λ“λ΅ μ‘λ™
                document.getElementById('userNameDisplay').textContent = 'κ²μ¤νΈ μ‚¬μ©μ';
                document.getElementById('loginButton').style.display = 'block';
                document.getElementById('homeButton').style.display = 'none';
                document.getElementById('currentPoints').textContent = '0P';
                renderAdMenu(); // μ¤λ¥ λ°μƒ μ‹μ—λ„ κ΄‘κ³  λ©”λ‰΄ λ λ”λ§
            }
        });

        // λ΅κ·Έμ•„μ›ƒ ν•¨μ
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }

        // ν¬μΈνΈ μ΄κ³Ό μ•λ‚΄ λ©”μ‹μ§€ ν‘μ‹ (μ¤‘λ³µ λ°©μ§€)
        let messageShown = false;
        function showPointsExceedMessage() {
            // μ΄λ―Έ λ©”μ‹μ§€κ°€ ν‘μ‹λμ–΄ μμΌλ©΄ μ¤‘λ³µ μ‹¤ν–‰ λ°©μ§€
            if (messageShown) return;
            
            messageShown = true;
            const messageDiv = document.createElement('div');
            messageDiv.className = 'fixed top-4 right-4 bg-yellow-500 text-black px-4 py-2 rounded-lg shadow-lg z-50';
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">β οΈ</span>
                    <span>ν¬μΈνΈκ°€ 500μ„ μ΄κ³Όν•μ—¬ μ¶©μ „μ΄ μ ν•λ©λ‹λ‹¤.</span>
                </div>
            `;
            document.body.appendChild(messageDiv);
            
            // 3μ΄ ν›„ λ©”μ‹μ§€ μ κ±°
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
                messageShown = false; // λ©”μ‹μ§€ μ κ±° ν›„ ν”λκ·Έ λ¦¬μ…‹
            }, 3000);
        }

        // κ΄‘κ³  μ‹μ²­
        let adPlaying = false;
        async function watchAd(duration, points, videoUrl, title) {
            if (adPlaying) return;
            if (!currentUser) {
                alert('λ΅κ·ΈμΈ ν›„ κ΄‘κ³  μ‹μ²­μ„ μ΄μ©ν•΄μ£Όμ„Έμ”.');
                window.location.href = '/login.html';
                return;
            }
            
            // 500ν¬μΈνΈ μ΄κ³Ό μ‹ κ΄‘κ³  μ‹μ²­ μ ν•
            if (currentUser.points > 500) {
                alert('ν¬μΈνΈκ°€ 500μ„ μ΄κ³Όν•μ—¬ κ΄‘κ³  μ‹μ²­μ΄ μ ν•λ©λ‹λ‹¤.');
                return;
            }
            
            // 10λ¶„ μ ν• μ κ±° - μ–Έμ λ“ μ§€ μ‹μ²­ κ°€λ¥
            adPlaying = true;

            // κ΄‘κ³  λ¨λ‹¬ ν‘μ‹
            const adModal = document.getElementById('adModal');
            const adTitle = document.getElementById('adTitle');
            const adVideo = document.getElementById('adVideo');
            const countdown = document.getElementById('countdown');
            adTitle.textContent = title;
            adModal.style.display = 'flex';
            countdown.textContent = duration;

            // λ™μμƒ μ„¤μ • λ° μ¬μƒ
            const videoElement = document.getElementById('adVideoElement');
            videoElement.src = videoUrl;
            videoElement.currentTime = 0;
            
            // λ™μμƒ λ΅λ“ μ™„λ£ ν›„ μ¬μƒ
            videoElement.onloadeddata = function() {
                videoElement.play().catch(error => {
                    console.log('μλ™ μ¬μƒ μ‹¤ν¨, μλ™ μ¬μƒ ν•„μ”:', error);
                });
            };
            
            // λ‚¨μ€ μ‹κ°„ ν‘μ‹
            let timeLeft = duration;
            const timer = setInterval(() => {
                timeLeft--;
                countdown.textContent = timeLeft > 0 ? timeLeft : 0;
                if (timeLeft <= 0) clearInterval(timer);
            }, 1000);

            // μμƒμ΄ λλ‚κ±°λ‚ durationμ΄κ°€ μ§€λ‚λ©΄ ν¬μΈνΈ μ§€κΈ‰ λ° μ΄λ™
            let finished = false;
            async function finishAd() {
                if (finished) return;
                finished = true;
                clearInterval(timer);
                videoElement.pause();
                videoElement.src = '';
                adModal.style.display = 'none';
                localStorage.setItem('adWatched_' + duration, Date.now().toString());
                renderAdMenu();
                
                // ν¬μΈνΈ μ§€κΈ‰ μ²λ¦¬
                let serverUpdateSuccess = false;
                try {
                    // μ„λ²„ API νΈμ¶ μ‹λ„ (ν¬μΈνΈ μ¶”κ°€ λ°©μ‹)
                    const response = await fetch('/api/update-points', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.userId, 
                            addPoints: points  // μ¶”κ°€ν•  ν¬μΈνΈ
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // μ„λ²„ μ—…λ°μ΄νΈ μ„±κ³µ - μ„λ²„μ—μ„ λ°›μ€ ν¬μΈνΈλ΅ μ—…λ°μ΄νΈ
                            currentUser.points = data.points;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            console.log('β… μ„λ²„ ν¬μΈνΈ μ—…λ°μ΄νΈ μ™„λ£:', data.points);
                            serverUpdateSuccess = true;
                        } else {
                            // μ„λ²„ μ¤λ¥ μ‹ ν΄λΌμ΄μ–ΈνΈμ—μ„ ν¬μΈνΈ μ§€κΈ‰
                            console.error('β μ„λ²„ ν¬μΈνΈ μ—…λ°μ΄νΈ μ‹¤ν¨:', data.message);
                            currentUser.points += points;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            console.log('β… ν΄λΌμ΄μ–ΈνΈ ν¬μΈνΈ μ—…λ°μ΄νΈ μ™„λ£:', currentUser.points);
                        }
                    } else {
                        // μ„λ²„ μ—°κ²° μ‹¤ν¨ μ‹ ν΄λΌμ΄μ–ΈνΈμ—μ„ ν¬μΈνΈ μ§€κΈ‰
                        console.error('β μ„λ²„ μ—°κ²° μ‹¤ν¨');
                        currentUser.points += points;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        console.log('β… ν΄λΌμ΄μ–ΈνΈ ν¬μΈνΈ μ—…λ°μ΄νΈ μ™„λ£:', currentUser.points);
                    }
                } catch (error) {
                    console.error('β ν¬μΈνΈ μ§€κΈ‰ μ¤λ¥:', error);
                    // μ¤λ¥κ°€ λ°μƒν•΄λ„ ν΄λΌμ΄μ–ΈνΈμ—μ„ ν¬μΈνΈ μ§€κΈ‰
                    currentUser.points += points;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    console.log('β… ν΄λΌμ΄μ–ΈνΈ ν¬μΈνΈ μ—…λ°μ΄νΈ μ™„λ£:', currentUser.points);
                }
                
                // μ„±κ³µ μ•λ¦Ό
                const message = serverUpdateSuccess 
                    ? `${duration}μ΄ κ΄‘κ³  μ‹μ²­ μ™„λ£!\n${points.toLocaleString()}ν¬μΈνΈκ°€ μ§€κΈ‰λμ—μµλ‹λ‹¤.`
                    : `${duration}μ΄ κ΄‘κ³  μ‹μ²­ μ™„λ£!\n${points.toLocaleString()}ν¬μΈνΈκ°€ μ§€κΈ‰λμ—μµλ‹λ‹¤.\n(μ„λ²„ μ—°κ²° μ‹¤ν¨λ΅ μ„μ‹ μ§€κΈ‰)`;
                alert(message);
                
                // ν¬μΈνΈ μ—…λ°μ΄νΈ ν›„ κ΄‘κ³  λ©”λ‰΄ λ‹¤μ‹ λ λ”λ§
                document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                renderAdMenu();
                
                // ν¬μΈνΈκ°€ 500μ„ μ΄κ³Όν•λ©΄ μ•λ‚΄ λ©”μ‹μ§€ ν‘μ‹
                if (currentUser.points > 500) {
                    showPointsExceedMessage();
                }
                
                // 3μ΄ ν›„ index.htmlλ΅ μ΄λ™
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            }
            // λ™μμƒ μΆ…λ£ μ΄λ²¤νΈ
            videoElement.onended = function() {
                finishAd();
            };
            
            // durationμ΄κ°€ μ§€λ‚λ©΄ κ΄‘κ³  μ™„λ£ (λ°±μ—…)
            setTimeout(finishAd, duration * 1000);
        }
    </script>
</body>
</html> 