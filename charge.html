<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ν¬μΈνΈ μ¶©μ „</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        console.warn = function() {};
        console.error = function() {};
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- μƒλ‹¨ λ„¤λΉ„κ²μ΄μ… -->
    <nav class="bg-gray-800 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">ν¬μΈνΈ μ¶©μ „</h1>
                <span id="userNameDisplay" class="text-gray-300">λ΅λ”© μ¤‘...</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="currentPoints" class="text-yellow-400 font-bold">0P</span>
                <button id="homeButton" onclick="window.location.href='index.html'" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-home mr-2"></i>ν™μΌλ΅
                </button>
                <button id="loginButton" onclick="window.location.href='login.html'" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>λ΅κ·ΈμΈ
                </button>
            </div>
        </div>
    </nav>

    <!-- λ©”μΈ μ»¨ν…μΈ  -->
    <div class="container mx-auto px-4 py-8">
        <!-- ν¬μΈνΈ μ¶©μ „ μ•λ‚΄ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-center">
                <i class="fas fa-coins text-yellow-400 mr-2"></i>
                ν¬μΈνΈ μ¶©μ „
            </h2>
            <p class="text-gray-300 text-center mb-6">
                κ²μ„ μ†κ° μ‹μ²­μ„ ν†µν•΄ ν¬μΈνΈλ¥Ό μ¶©μ „ν•μ„Έμ”.<br>
                <span class="text-red-400 font-bold">500ν¬μΈνΈ μ΄μƒ λ³΄μ  μ‹ μ¶©μ „μ΄ μ ν•λ©λ‹λ‹¤.</span>
            </p>
        </div>

        <!-- κ²μ„ μ†κ° μµμ… -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div id="ad10" class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-6 text-center cursor-pointer hover:from-blue-700 hover:to-blue-800 transition-all duration-300">
                <div class="text-4xl mb-4">
                    <i class="fas fa-gamepad"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">κ²μ„ μ†κ° 1</h3>
                <p class="text-2xl font-bold text-yellow-400 mb-2">1,000P</p>
                <p class="text-sm text-gray-300">κ²μ„ κΈ°λ³Έ κ·μΉ™</p>
            </div>

            <div id="ad20" class="bg-gradient-to-br from-green-600 to-green-700 rounded-lg p-6 text-center cursor-pointer hover:from-green-700 hover:to-green-800 transition-all duration-300">
                <div class="text-4xl mb-4">
                    <i class="fas fa-book"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">κ²μ„ κ·μΉ™</h3>
                <p class="text-2xl font-bold text-yellow-400 mb-2">2,000P</p>
                <p class="text-sm text-gray-300">μƒμ„Έν• κ²μ„ κ·μΉ™</p>
            </div>

            <div id="ad30" class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-6 text-center cursor-pointer hover:from-purple-700 hover:to-purple-800 transition-all duration-300">
                <div class="text-4xl mb-4">
                    <i class="fas fa-coins"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">λ°°ν… κ·μΉ™</h3>
                <p class="text-2xl font-bold text-yellow-400 mb-2">3,000P</p>
                <p class="text-sm text-gray-300">μƒμ„Έν• λ°°ν… κ·μΉ™</p>
            </div>
        </div>

        <!-- μ•λ‚΄ λ©”μ‹μ§€ -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h3 class="text-lg font-bold mb-4">
                <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                μ΄μ© μ•λ‚΄
            </h3>
            <ul class="text-gray-300 space-y-2">
                <li><i class="fas fa-check text-green-400 mr-2"></i>κ²μ„ μ†κ° μ‹μ²­ μ™„λ£ ν›„ μ¦‰μ‹ ν¬μΈνΈκ°€ μ§€κΈ‰λ©λ‹λ‹¤.</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>500ν¬μΈνΈ μ΄μƒ λ³΄μ  μ‹ μ¶©μ „μ΄ μ ν•λ©λ‹λ‹¤.</li>
                <li><i class="fas fa-check text-green-400 mr-2"></i>λ΅κ·ΈμΈ ν›„ μ΄μ© κ°€λ¥ν•©λ‹λ‹¤.</li>
            </ul>
        </div>
    </div>

    <!-- κ²μ„ μ†κ° λ¨λ‹¬ -->
    <div id="adModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-4xl w-full mx-4">
            <div class="text-center">
                <h3 id="adTitle" class="text-xl font-bold mb-4">λΉ λλ‚μΈ κ²μ„ μ†κ°</h3>
                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                    <canvas id="adCanvas" width="640" height="360" class="w-full rounded border border-gray-600"></canvas>
                </div>
                <div class="text-center mb-4">
                    <p class="text-lg">λ‚¨μ€ μ‹κ°„: <span id="countdown" class="font-bold text-yellow-400">0</span>μ΄</p>
                </div>
                <div class="bg-gray-700 rounded-lg p-4">
                    <p class="text-sm text-gray-300">
                        κ²μ„ μ†κ° μ‹μ²­μ΄ μ™„λ£λλ©΄ μλ™μΌλ΅ ν¬μΈνΈκ°€ μ§€κΈ‰λ©λ‹λ‹¤.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 500ν¬μΈνΈ μ΄κ³Ό κ²½κ³  λ¨λ‹¬ -->
    <div id="warningModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-red-800 rounded-lg p-6 max-w-md w-full mx-4 text-center">
            <div class="text-4xl mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
            </div>
            <h3 class="text-xl font-bold mb-4 text-white">ν¬μΈνΈ μ¶©μ „ μ ν•</h3>
            <p class="text-gray-200 mb-6">
                ν„μ¬ λ³΄μ  ν¬μΈνΈκ°€ 500μ„ μ΄κ³Όν•μ—¬<br>
                ν¬μΈνΈ μ¶©μ „μ΄ μ ν•λ©λ‹λ‹¤.
            </p>
            <div class="text-sm text-gray-300">
                <p>5μ΄ ν›„ λ©”μΈ νμ΄μ§€λ΅ μ΄λ™ν•©λ‹λ‹¤...</p>
                <p id="countdownText" class="text-yellow-400 font-bold text-lg mt-2">5</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let adPlaying = false;
        let speechQueue = [];
        let isSpeaking = false;

        // κ²μ„ μ†κ° μµμ… μ„¤μ •
        const adOptions = {
            10: { 
                points: 1000, 
                title: 'κ²μ„ μ†κ° 1 - κΈ°λ³Έ κ·μΉ™',
                content: 'κ³µκ²©ν•λ” ν€μ μ„ μκ°€ νƒ€μ„μ— λ“¤μ–΄μ„ λ¶€ν„° ν¬μκ°€ ν¬κµ¬λ¥Ό ν•κΈ° μ§μ „κΉμ§€ κ²μ΄λ¨Έλ” ν¬μ/νƒ€μ/μλΉ„μλ¥Ό λ€μƒμΌλ΅ κ³µκ²© κ²°κ³Όμ— λ€ν• μμΈ΅μ„ ν•μ—¬ μΌμ •μ μλ¥Ό λ² ν… ν•λ‹¤.'
            },
            20: { 
                points: 2000, 
                title: 'κ²μ„ κ·μΉ™ - μƒμ„Έ κ·μΉ™',
                content: 'νƒ€μκ°€ νƒ€μ„μ— λ“¤μ–΄μ„λ©΄ κ²μ΄λ¨Έλ“¤μ λ² ν…μ΄ μ‹μ‘λλ©°, ν¬μκ°€ ν¬κµ¬λ¥Ό ν•κΈ° μ„ν•΄ μ„ΈνΈ ν¬μ§€μ…μ— μ„ν–μ„ λ• λ² ν…μ μ ‘μ†μ΄ μ¤‘λ‹¨λλ‹¤. κ²μ΄λ¨Έλ”, ν¬μμ ν¬κµ¬μ— λ€ν• κ³µκ²©μ κ²°κ³Ό (1λ£¨/2λ£¨/3λ£¨/ν™λ°/μ•„μ›ƒ 5κ°€μ§€ κ²½μ°μ μ) λ¥Ό μμƒν•κ³  μΌμ • μ μλ¥Ό 1νμ— ν•ν•μ—¬ ν¬μ/νƒ€μ/μλΉ„μ(9κ°€μ§€ κ²½μ°μ μ)μ—κ² κ°κ° λ² ν…μ„ ν•λ‹¤. ν¬μ/νƒ€μ/μλΉ„μμ κ³µκ²©/μλΉ„ κ²°κ³Όμ— λ”°λΌ, κ³µκ²©/μλΉ„ κ²°κ³Όλ¥Ό λ§μ¶ κ²μ΄λ¨Έλ“¤μ—κ² κ³µκ²©/μλΉ„ κ²°κ³Όλ¥Ό λ§μ¶”μ§€ λ»ν• λ‚λ¨Έμ§€ κ²μ΄λ¨Έλ“¤μ μ μλ¥Ό κ· λ“±ν•κ² λ°°λ¶„ν•μ—¬ κ°€μ‚° μ‹μΌμ¤€λ‹¤. κ²μ„μ μ‹μ‘κ³Ό μΆ…λ£λ”, κ²½κΈ° μ¤‘κ³„λ°©μ†΅μ΄ μ‹μ‘λλ” μ‹μ μ— μ‹μ‘ν•μ—¬ κ²½κΈ° μΆ…λ£λ΅ μ¤‘κ³„λ°©μ†΅μ΄ μΆ…λ£κ°€ λμ—κ±°λ‚, λ°©μ†΅μ‚¬μ μ‚¬μ •μΌλ΅ μ¤‘κ³„λ°©μ†΅μ΄ μ¤‘λ‹¨λ  κ²½μ° κ²μ„λ„ μΆ…λ£λλ‹¤.'
            },
            30: { 
                points: 3000, 
                title: 'λ°°ν… κ·μΉ™ - μƒμ„Έ κ·μΉ™',
                content: 'κ²μ΄λ¨Έκ°€ μ°Έμ—¬ κ²½κΈ°λ¥Ό μ„ νƒν• ν›„ λ΅κ·ΈμΈμ„ν•λ©΄, κΈ°λ³Έ μ μ 1,000μ μ„ λ¶€μ—¬ν•λ©°, κ²½κΈ°μ¤‘μ—λ„ ν¬μΈνΈκ°€ λ¶€μ΅±ν•  κ²½μ° νμ›μ λ“±κΈ‰μ— λ”°λΌ λ¬΄λ£/μ λ£λ΅ μ¶©μ „μ„ ν•  μκ°€ μλ‹¤. 1ν μ΄ μ²« νƒ€μλ¶€ν„° ν€μ— κ΄€κ³„μ—†μ΄ ν¬μμ™€ νƒ€μ„μ— λ“¤μ–΄μ„λ” λ§¤ νƒ€μλ§λ‹¤ 100μ μ”© λ² ν…ν•λ©° μ¶”κ°€λ΅ μ λ£κ²°μ λ΅ μ μμ¶©μ „μ„ ν•μ—¬ κ²½κΈ°κ°€ μΆ…λ£(μ •κ·μ΄λ‹ νΉμ€ μ—°μ¥μ „ ν¬ν•¨)λ  λ•κΉμ§€ λ² ν…μ„ ν•λ‹¤. (μλΉ„μμ— λ€ν• κ·μΉ™μ€ λ³„λ„λ΅ μ¶”κ°€)'
            }
        };

        // νμ΄μ§€ λ΅λ“ μ‹ μ‹¤ν–‰
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    
                    // userIdκ°€ μ—†λ” κ²½μ° κΈ°λ³Έκ°’ μ„¤μ •
                    if (!currentUser.userId) {
                        currentUser.userId = currentUser.name || 'guest_' + Date.now();
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                    console.log('π” λ΅λ“λ μ‚¬μ©μ μ •λ³΄:', currentUser);
                    
                    // μ‚¬μ©μ μ •λ³΄ ν‘μ‹
                    document.getElementById('userNameDisplay').textContent = `${currentUser.name}λ‹`;
                    document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                    document.getElementById('loginButton').style.display = 'none';
                    document.getElementById('homeButton').style.display = 'block';

                    // 500ν¬μΈνΈ μ΄κ³Ό μ²΄ν¬
                    if (currentUser.points > 500) {
                        showWarningModal();
                        return;
                    }

                    // κ΄‘κ³  λ²„νΌ ν™μ„±ν™”
                    enableAdButtons();
                } else {
                    // λ΅κ·ΈμΈν•μ§€ μ•μ€ μ‚¬μ©μ
                    document.getElementById('userNameDisplay').textContent = 'κ²μ¤νΈ μ‚¬μ©μ';
                    document.getElementById('currentPoints').textContent = '0P';
                    document.getElementById('loginButton').style.display = 'block';
                    document.getElementById('homeButton').style.display = 'none';
                    
                    // κ΄‘κ³  λ²„νΌ λΉ„ν™μ„±ν™”
                    disableAdButtons();
                }
            } catch (error) {
                console.error('μ‚¬μ©μ μ •λ³΄ λ΅λ“ μ‹¤ν¨:', error);
                disableAdButtons();
            }
        });

        // κ΄‘κ³  λ²„νΌ ν™μ„±ν™”
        function enableAdButtons() {
            document.getElementById('ad10').onclick = () => watchAd(10);
            document.getElementById('ad20').onclick = () => watchAd(20);
            document.getElementById('ad30').onclick = () => watchAd(30);
        }

        // κ΄‘κ³  λ²„νΌ λΉ„ν™μ„±ν™”
        function disableAdButtons() {
            const adButtons = document.querySelectorAll('#ad10, #ad20, #ad30');
            adButtons.forEach(btn => {
                btn.onclick = null;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('cursor-pointer');
            });
        }

        // 500ν¬μΈνΈ μ΄κ³Ό κ²½κ³  λ¨λ‹¬ ν‘μ‹
        function showWarningModal() {
            const modal = document.getElementById('warningModal');
            modal.style.display = 'flex';
            
            let countdown = 5;
            const countdownElement = document.getElementById('countdownText');
            
            const timer = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    window.location.href = 'index.html';
                }
            }, 1000);
        }

        // μμ„± ν μ²λ¦¬ ν•¨μ
        function processSpeechQueue() {
            if (speechQueue.length === 0 || isSpeaking) {
                return;
            }
            isSpeaking = true;
            const { text, rate, pitch } = speechQueue.shift();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = rate || 0.9;
            utterance.pitch = pitch || 1.1;
            utterance.volume = 0.9;
            utterance.onstart = () => { console.log('π¤ μμ„± μ¬μƒ μ‹μ‘:', text); };
            utterance.onend = () => {
                console.log('π¤ μμ„± μ¬μƒ μ™„λ£:', text);
                isSpeaking = false;
                setTimeout(() => processSpeechQueue(), 100);
            };
            utterance.onerror = (event) => {
                console.log('π¤ μμ„± μ¬μƒ μ¤λ¥:', event.error);
                isSpeaking = false;
                setTimeout(() => processSpeechQueue(), 100);
            };
            speechSynthesis.speak(utterance);
            console.log('π¤ μμ„± μ¬μƒ μ”μ²­ μ™„λ£:', text);
        }

        // μμ„± μ¬μƒ ν•¨μ
        function speakText(text, rate = 0.9) {
            console.log('π¤ μμ„± μ¬μƒ μ‹λ„:', text);
            if ('speechSynthesis' in window) {
                speechQueue.push({ text, rate, pitch: 1.1 });
                console.log('π¤ μμ„± νμ— μ¶”κ°€λ¨:', text);
                processSpeechQueue();
            } else {
                console.log('π¤ μμ„± ν•©μ„± APIλ¥Ό μ§€μ›ν•μ§€ μ•μµλ‹λ‹¤.');
            }
        }

        // κ²μ„ μ†κ° μ‹μ²­
        async function watchAd(duration) {
            if (adPlaying) return;
            if (!currentUser) {
                alert('λ΅κ·ΈμΈ ν›„ κ²μ„ μ†κ° μ‹μ²­μ„ μ΄μ©ν•΄μ£Όμ„Έμ”.');
                window.location.href = 'login.html';
                return;
            }

            // 500ν¬μΈνΈ μ΄κ³Ό μ²΄ν¬
            if (currentUser.points > 500) {
                alert('ν¬μΈνΈκ°€ 500μ„ μ΄κ³Όν•μ—¬ κ΄‘κ³  μ‹μ²­μ΄ μ ν•λ©λ‹λ‹¤.');
                return;
            }

            adPlaying = true;
            const points = adOptions[duration].points;
            const title = adOptions[duration].title;

            // κ΄‘κ³  λ¨λ‹¬ ν‘μ‹
            const modal = document.getElementById('adModal');
            const adTitle = document.getElementById('adTitle');
            const adCanvas = document.getElementById('adCanvas');
            const countdown = document.getElementById('countdown');
            
            adTitle.textContent = title;
            modal.style.display = 'flex';
            countdown.textContent = duration;

            // Canvas μ„¤μ •
            const ctx = adCanvas.getContext('2d');
            ctx.fillStyle = '#1f2937';
            ctx.fillRect(0, 0, adCanvas.width, adCanvas.height);

            // μ• λ‹λ©”μ΄μ… μ‹μ‘
            startAdAnimation(ctx, duration);
            
            // κ²μ„ μ†κ° μ‹μ‘ μμ„±
            setTimeout(() => {
                const content = adOptions[duration].content;
                if (duration === 20) {
                    speakText('κ²μ„ κ·μΉ™μ„ μ‹μ‘ν•©λ‹λ‹¤.');
                } else if (duration === 30) {
                    speakText('λ°°ν… κ·μΉ™μ„ μ‹μ‘ν•©λ‹λ‹¤.');
                } else {
                    speakText('κ²μ„ μ†κ° 1μ„ μ‹μ‘ν•©λ‹λ‹¤.');
                }
                setTimeout(() => {
                    speakText(content);
                }, 2000);
            }, 500);

            // μΉ΄μ΄νΈλ‹¤μ΄
            let timeLeft = duration;
            const timer = setInterval(() => {
                timeLeft--;
                countdown.textContent = timeLeft > 0 ? timeLeft : 0;
                if (timeLeft <= 0) clearInterval(timer);
            }, 1000);

            // κ΄‘κ³  μ™„λ£ μ²λ¦¬
            let finished = false;
            async function finishAd() {
                if (finished) return;
                finished = true;
                
                clearInterval(timer);
                modal.style.display = 'none';
                adPlaying = false;

                // ν¬μΈνΈ μ§€κΈ‰ μ²λ¦¬
                try {
                    console.log('π” ν„μ¬ μ‚¬μ©μ μ •λ³΄:', currentUser);
                    console.log('π” μ „μ†΅ν•  λ°μ΄ν„°:', { userId: currentUser.userId, addPoints: points });
                    
                    const response = await fetch('/api/update-points', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.userId, 
                            addPoints: points
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // μ„λ²„ μ—…λ°μ΄νΈ μ„±κ³µ
                            currentUser.points = data.points;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                            
                            // κ²μ„ μ†κ° μ™„λ£ μμ„±
                            if (duration === 20) {
                                speakText(`κ²μ„ κ·μΉ™ μ‹μ²­μ΄ μ™„λ£λμ—μµλ‹λ‹¤. ${points.toLocaleString()}ν¬μΈνΈκ°€ μ§€κΈ‰λμ—μµλ‹λ‹¤.`);
                                alert(`${duration}μ΄ κ²μ„ κ·μΉ™ μ‹μ²­ μ™„λ£!\n${points.toLocaleString()}ν¬μΈνΈκ°€ μ§€κΈ‰λμ—μµλ‹λ‹¤.`);
                            } else if (duration === 30) {
                                speakText(`λ°°ν… κ·μΉ™ μ‹μ²­μ΄ μ™„λ£λμ—μµλ‹λ‹¤. ${points.toLocaleString()}ν¬μΈνΈκ°€ μ§€κΈ‰λμ—μµλ‹λ‹¤.`);
                                alert(`${duration}μ΄ λ°°ν… κ·μΉ™ μ‹μ²­ μ™„λ£!\n${points.toLocaleString()}ν¬μΈνΈκ°€ μ§€κΈ‰λμ—μµλ‹λ‹¤.`);
                            } else {
                                speakText(`κ²μ„ μ†κ° μ‹μ²­μ΄ μ™„λ£λμ—μµλ‹λ‹¤. ${points.toLocaleString()}ν¬μΈνΈκ°€ μ§€κΈ‰λμ—μµλ‹λ‹¤.`);
                                alert(`${duration}μ΄ κ²μ„ μ†κ° μ‹μ²­ μ™„λ£!\n${points.toLocaleString()}ν¬μΈνΈκ°€ μ§€κΈ‰λμ—μµλ‹λ‹¤.`);
                            }
                            
                            // ν¬μΈνΈ μ¶©μ „ ν›„μ—λ” κ²½κ³  λ¨λ‹¬ λ€μ‹  μ„±κ³µ λ©”μ‹μ§€λ§ ν‘μ‹
                            if (currentUser.points > 500) {
                                console.log('β… ν¬μΈνΈ μ¶©μ „ μ™„λ£ - 500ν¬μΈνΈ μ΄κ³Όλ΅ λ” μ΄μƒ μ¶©μ „ λ¶κ°€');
                            }
                        } else {
                            alert('ν¬μΈνΈ μ§€κΈ‰μ— μ‹¤ν¨ν–μµλ‹λ‹¤. λ‹¤μ‹ μ‹λ„ν•΄μ£Όμ„Έμ”.');
                        }
                    } else {
                        alert('μ„λ²„ μ—°κ²°μ— μ‹¤ν¨ν–μµλ‹λ‹¤. λ‹¤μ‹ μ‹λ„ν•΄μ£Όμ„Έμ”.');
                    }
                } catch (error) {
                    console.error('ν¬μΈνΈ μ§€κΈ‰ μ¤λ¥:', error);
                    alert('ν¬μΈνΈ μ§€κΈ‰ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤. λ‹¤μ‹ μ‹λ„ν•΄μ£Όμ„Έμ”.');
                }
            }

            // μ• λ‹λ©”μ΄μ… μ™„λ£λ” νƒ€μ΄λ¨Έλ΅ μ²λ¦¬
            
            // λ°±μ—… νƒ€μ΄λ¨Έ
            setTimeout(finishAd, duration * 1000);
        }

        // μμ„± ν•©μ„± ν•¨μ
        function speakText(text, rate = 0.9) {
            if ('speechSynthesis' in window) {
                // μ΄μ „ μμ„± μ¤‘μ§€
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = rate;
                utterance.pitch = 1.1;
                utterance.volume = 0.9;
                
                // μμ„± μ™„λ£ μ΄λ²¤νΈ
                utterance.onend = () => {
                    console.log('π¤ μμ„± μ¬μƒ μ™„λ£:', text);
                };
                
                utterance.onerror = (event) => {
                    console.log('π¤ μμ„± μ¬μƒ μ¤λ¥:', event.error);
                };
                
                speechSynthesis.speak(utterance);
            }
        }

        // κ΄‘κ³  μ• λ‹λ©”μ΄μ… ν•¨μ
        function startAdAnimation(ctx, duration) {
            const canvas = ctx.canvas;
            const width = canvas.width;
            const height = canvas.height;
            
            let startTime = Date.now();
            let animationId;
            let speechIndex = 0;
            let lastSpeechTime = 0;
            
            // κ²μ„ μ†κ° μ‹κ°„λ³„ λ‹¤λ¥Έ μμ„± λ‚΄μ©
            let speechTexts = [];
            
            if (duration === 10) {
                // 10μ΄ μ†κ°: κΈ°λ³Έ κ·μΉ™
                speechTexts = [
                    "κ³µκ²©ν•λ” ν€μ μ„ μκ°€ νƒ€μ„μ— λ“¤μ–΄μ„ λ¶€ν„° ν¬μκ°€ ν¬κµ¬λ¥Ό ν•κΈ° μ§μ „κΉμ§€",
                    "κ²μ΄λ¨Έλ” ν¬μ, νƒ€μ, μλΉ„μλ¥Ό λ€μƒμΌλ΅ κ³µκ²© κ²°κ³Όμ— λ€ν• μμΈ΅μ„ ν•μ—¬",
                    "μΌμ • μ μλ¥Ό λ² ν… ν•©λ‹λ‹¤"
                ];
            } else if (duration === 20) {
                // 20μ΄ μ†κ°: κ²μ„ κ·μΉ™
                speechTexts = [
                    "νƒ€μκ°€ νƒ€μ„μ— λ“¤μ–΄μ„λ©΄ κ²μ΄λ¨Έλ“¤μ λ² ν…μ΄ μ‹μ‘λλ©°",
                    "ν¬μκ°€ ν¬κµ¬λ¥Ό ν•κΈ° μ„ν•΄ μ„ΈνΈ ν¬μ§€μ…μ— μ„ν–μ„ λ• λ² ν…μ μ ‘μ†μ΄ μ¤‘λ‹¨λ©λ‹λ‹¤",
                    "κ²μ΄λ¨Έλ”, ν¬μμ ν¬κµ¬μ— λ€ν• κ³µκ²©μ κ²°κ³Ό",
                    "1λ£¨, 2λ£¨, 3λ£¨, ν™λ°, μ•„μ›ƒ 5κ°€μ§€ κ²½μ°μ μλ¥Ό μμƒν•κ³ ",
                    "μΌμ • μ μλ¥Ό 1νμ— ν•ν•μ—¬ ν¬μ, νƒ€μ, μλΉ„μ",
                    "9κ°€μ§€ κ²½μ°μ μμ—κ² κ°κ° λ² ν…μ„ ν•©λ‹λ‹¤",
                    "ν¬μ, νƒ€μ, μλΉ„μμ κ³µκ²©, μλΉ„ κ²°κ³Όμ— λ”°λΌ",
                    "κ³µκ²©, μλΉ„ κ²°κ³Όλ¥Ό λ§μ¶ κ²μ΄λ¨Έλ“¤μ—κ²",
                    "κ³µκ²©, μλΉ„ κ²°κ³Όλ¥Ό λ§μ¶”μ§€ λ»ν• λ‚λ¨Έμ§€ κ²μ΄λ¨Έλ“¤μ μ μλ¥Ό",
                    "κ· λ“±ν•κ² λ°°λ¶„ν•μ—¬ κ°€μ‚° μ‹μΌμ¤λ‹λ‹¤",
                    "κ²μ„μ μ‹μ‘κ³Ό μΆ…λ£λ”, κ²½κΈ° μ¤‘κ³„λ°©μ†΅μ΄ μ‹μ‘λλ” μ‹μ μ— μ‹μ‘ν•μ—¬",
                    "κ²½κΈ° μΆ…λ£λ΅ μ¤‘κ³„λ°©μ†΅μ΄ μΆ…λ£κ°€ λμ—κ±°λ‚",
                    "λ°©μ†΅μ‚¬μ μ‚¬μ •μΌλ΅ μ¤‘κ³„λ°©μ†΅μ΄ μ¤‘λ‹¨λ  κ²½μ° κ²μ„λ„ μΆ…λ£λ©λ‹λ‹¤"
                ];
            } else if (duration === 30) {
                // 30μ΄ μ†κ°: λ°°ν… κ·μΉ™
                speechTexts = [
                    "κ²μ΄λ¨Έκ°€ μ°Έμ—¬ κ²½κΈ°λ¥Ό μ„ νƒν• ν›„ λ΅κ·ΈμΈμ„ν•λ©΄",
                    "κΈ°λ³Έ μ μ 1,000μ μ„ λ¶€μ—¬ν•λ©°",
                    "κ²½κΈ°μ¤‘μ—λ„ ν¬μΈνΈκ°€ λ¶€μ΅±ν•  κ²½μ°",
                    "νμ›μ λ“±κΈ‰μ— λ”°λΌ λ¬΄λ£, μ λ£λ΅ μ¶©μ „μ„ ν•  μκ°€ μμµλ‹λ‹¤",
                    "1ν μ΄ μ²« νƒ€μλ¶€ν„° ν€μ— κ΄€κ³„μ—†μ΄",
                    "ν¬μμ™€ νƒ€μ„μ— λ“¤μ–΄μ„λ” λ§¤ νƒ€μλ§λ‹¤ 100μ μ”© λ² ν…ν•λ©°",
                    "μ¶”κ°€λ΅ μ λ£κ²°μ λ΅ μ μμ¶©μ „μ„ ν•μ—¬",
                    "κ²½κΈ°κ°€ μΆ…λ£, μ •κ·μ΄λ‹ νΉμ€ μ—°μ¥μ „ ν¬ν•¨λ  λ•κΉμ§€ λ² ν…μ„ ν•©λ‹λ‹¤",
                    "μλΉ„μμ— λ€ν• κ·μΉ™μ€ λ³„λ„λ΅ μ¶”κ°€λ©λ‹λ‹¤"
                ];
            }
            
            // λ°°ν… κ·μΉ™ κ΄€λ ¨ ν…μ¤νΈλ“¤ (ν™”λ©΄ ν‘μ‹μ©)
            const texts = [
                { text: "λΉ λλ‚μΈ μ•Όκµ¬κ²μ„", x: width/2, y: 80, size: 32, color: "#fbbf24" },
                { text: "μƒμ„Έν• λ°°ν… κ·μΉ™", x: width/2, y: 120, size: 24, color: "#60a5fa" },
                { text: "κΈ°λ³Έ μ μ 1,000μ ", x: width/2, y: 160, size: 20, color: "#34d399" },
                { text: "λ§¤ νƒ€μλ§λ‹¤ 100μ ", x: width/2, y: 200, size: 20, color: "#f87171" },
                { text: "λ¬΄λ£/μ λ£ μ¶©μ „", x: width/2, y: 240, size: 20, color: "#a78bfa" },
                { text: "κ²½κΈ° μΆ…λ£κΉμ§€", x: width/2, y: 280, size: 20, color: "#fbbf24" }
            ];
            
            // μ•Όκµ¬κ³µ μ• λ‹λ©”μ΄μ…
            let ballX = 50;
            let ballY = height/2;
            let ballSpeedX = 3;
            let ballSpeedY = 2;
            
            // λ°°νΈ μ• λ‹λ©”μ΄μ…
            let batAngle = 0;
            let batSpeed = 0.1;
            
            function animate() {
                const currentTime = Date.now();
                const elapsed = (currentTime - startTime) / 1000;
                
                if (elapsed >= duration) {
                    cancelAnimationFrame(animationId);
                    return;
                }
                
                // λ°°κ²½ κ·ΈλΌλ°μ΄μ…
                const gradient = ctx.createLinearGradient(0, 0, width, height);
                gradient.addColorStop(0, '#1e3a8a');
                gradient.addColorStop(1, '#1f2937');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);
                
                // μ•Όκµ¬κ³µ μ›€μ§μ„
                ballX += ballSpeedX;
                ballY += ballSpeedY;
                
                if (ballX > width - 20 || ballX < 20) ballSpeedX *= -1;
                if (ballY > height - 20 || ballY < 20) ballSpeedY *= -1;
                
                // μ•Όκµ¬κ³µ κ·Έλ¦¬κΈ°
                ctx.beginPath();
                ctx.arc(ballX, ballY, 15, 0, 2 * Math.PI);
                ctx.fillStyle = '#ffffff';
                ctx.fill();
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // μ•Όκµ¬κ³µ μ¤ν‹°μΉ
                ctx.beginPath();
                ctx.moveTo(ballX - 15, ballY);
                ctx.lineTo(ballX + 15, ballY);
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // λ°°νΈ μ• λ‹λ©”μ΄μ…
                batAngle += batSpeed;
                const batX = width/2 + 100;
                const batY = height/2;
                
                ctx.save();
                ctx.translate(batX, batY);
                ctx.rotate(batAngle);
                ctx.fillStyle = '#8b4513';
                ctx.fillRect(-5, -40, 10, 80);
                ctx.restore();
                
                // ν…μ¤νΈ μ• λ‹λ©”μ΄μ…κ³Ό μμ„± μ¬μƒ
                texts.forEach((item, index) => {
                    const alpha = Math.sin(elapsed * 2 + index * 0.5) * 0.5 + 0.5;
                    ctx.fillStyle = item.color;
                    ctx.globalAlpha = alpha;
                    ctx.font = `bold ${item.size}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(item.text, item.x, item.y);
                    
                    // μμ„± μ¬μƒ (κ° ν…μ¤νΈκ°€ κ°•μ΅°λ  λ•)
                    const textStartTime = (duration / speechTexts.length) * index;
                    const textEndTime = (duration / speechTexts.length) * (index + 1);
                    
                    if (elapsed >= textStartTime && elapsed <= textEndTime && 
                        elapsed - lastSpeechTime > 3 && speechIndex === index) {
                        speakText(speechTexts[index]);
                        lastSpeechTime = elapsed;
                        speechIndex = (speechIndex + 1) % speechTexts.length;
                    }
                });
                
                // μ§„ν–‰λ¥  ν‘μ‹
                const progress = elapsed / duration;
                ctx.fillStyle = '#fbbf24';
                ctx.fillRect(50, height - 30, (width - 100) * progress, 10);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.strokeRect(50, height - 30, width - 100, 10);
                
                // μ§„ν–‰λ¥  ν…μ¤νΈ
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${Math.round(progress * 100)}%`, width/2, height - 10);
                
                ctx.globalAlpha = 1;
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
        }
    </script>
</body>
</html> 