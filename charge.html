<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포인트 충전</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        console.warn = function() {};
        console.error = function() {};
    </script>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">
    <!-- 상단 네비게이션 -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 p-4 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">포인트 충전</h1>
                <span id="userNameDisplay" class="text-gray-300">로딩 중...</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="currentPoints" class="text-yellow-400 font-bold">0P</span>
                <button id="homeButton" onclick="window.location.href='index.html'" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-home mr-2"></i>홈으로
                </button>
                <button id="loginButton" onclick="window.location.href='login.html'" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>로그인
                </button>
            </div>
        </div>
    </nav>

    <!-- 메인 컨텐츠 -->
    <div class="w-full px-2 py-2 flex-1 overflow-y-auto pt-16 pb-16">


        <!-- 빠던나인 소개 동영상 -->
        <div class="grid grid-cols-1 gap-2 mb-2">
            <div id="videoOption" class="bg-gradient-to-br from-sky-400 to-sky-500 rounded-lg p-3 text-center cursor-pointer hover:from-sky-500 hover:to-sky-600 transition-all duration-300" data-selected="false">
                <div class="mb-2">
                    <img src="/img/mascot.png" alt="빠던나인 마스코트" class="w-14 h-14 mx-auto rounded-full border-2 border-white shadow-lg">
                </div>
                <h3 class="text-base font-bold mb-1 text-white">빠던나인 소개 동영상</h3>
                <p class="text-lg font-bold text-yellow-300 mb-1">1,000P</p>
                <p class="text-xs text-gray-200">클릭하여 선택</p>
                <div class="mt-2">
                    <i class="fas fa-check-circle text-white text-lg" style="display: none;"></i>
                </div>
            </div>
            <div id="videoOption2" class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg p-3 text-center cursor-pointer hover:from-indigo-600 hover:to-indigo-700 transition-all duration-300" data-selected="false">
                <div class="mb-2">
                    <img src="/img/mascot.png" alt="빠던나인 마스코트" class="w-14 h-14 mx-auto rounded-full border-2 border-white shadow-lg">
                </div>
                <h3 class="text-base font-bold mb-1 text-white">빠던나인 소개 동영상</h3>
                <p class="text-lg font-bold text-yellow-300 mb-1">1,000P</p>
                <p class="text-xs text-gray-200">클릭하여 선택</p>
                <div class="mt-2">
                    <i class="fas fa-check-circle text-white text-lg" style="display: none;"></i>
                </div>
            </div>
            <div id="videoOption3" class="bg-gradient-to-br from-amber-400 to-amber-500 rounded-lg p-3 text-center cursor-pointer hover:from-amber-500 hover:to-amber-600 transition-all duration-300" data-selected="false">
                <div class="mb-2">
                    <img src="/img/mascot.png" alt="빠던나인 마스코트" class="w-14 h-14 mx-auto rounded-full border-2 border-white shadow-lg">
                </div>
                <h3 class="text-base font-bold mb-1 text-gray-800">빠던나인 소개 동영상</h3>
                <p class="text-lg font-bold text-yellow-700 mb-1">1,000P</p>
                <p class="text-xs text-gray-600">클릭하여 선택</p>
                <div class="mt-2">
                    <i class="fas fa-check-circle text-amber-600 text-lg" style="display: none;"></i>
                </div>
            </div>
        </div>

        <!-- 선택된 동영상 시청 버튼 -->
        <div class="text-center mb-4">
            <button id="watchSelectedVideos" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300" style="display: none;">
                <i class="fas fa-play-circle mr-2"></i>
                선택된 동영상 시청하기
            </button>
        </div>


    </div>

    <!-- 하단 네비게이션 -->
    <nav class="fixed bottom-0 left-0 right-0 bg-black text-white py-3 border-t border-gray-700 z-50">
        <div class="flex justify-evenly">
            <div class="text-center cursor-pointer" onclick="location.href='invite.html'">
                <i class="fas fa-user-plus text-2xl"></i>
                <p class="text-[0.4rem]">초대</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='attendance.html'">
                <i class="fas fa-calendar-alt text-2xl"></i>
                <p class="text-[0.4rem]">출석부</p>
            </div>
                        <div class="text-center cursor-pointer" onclick="location.href='board.html'">
                <i class="fas fa-clipboard text-2xl"></i>
                <p class="text-[0.4rem]">게시판</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='charge.html'">
                <i class="fas fa-coins text-2xl"></i>
                <p class="text-[0.4rem]">포인트충전</p>
            </div>
        </div>
    </nav>

    <!-- 동영상 모달 -->
    <div id="videoModal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-50">
        <div class="w-full h-full flex flex-col">
            <!-- 상단 닫기 버튼 -->
            <div class="flex justify-end p-4">
                <button onclick="closeVideoModal()" class="text-white hover:text-gray-300 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- 동영상 플레이어 -->
            <div class="flex-1 flex items-center justify-center p-4">
                <video id="mascotVideo" class="w-full max-w-4xl rounded-lg" controls>
                    <source src="/img/mascot.mp4" type="video/mp4">
                    브라우저가 동영상을 지원하지 않습니다.
                </video>
            </div>
            
            <!-- 하단 안내 -->
            <div class="text-center p-4 text-white">
                <p class="text-base mb-2">동영상 시청 완료 시 1,000포인트가 지급됩니다</p>
                <p class="text-sm text-gray-300">동영상을 끝까지 시청해주세요</p>
            </div>
        </div>


    <!-- 500포인트 초과 경고 모달 -->
    <div id="warningModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-red-800 rounded-lg p-6 max-w-md w-full mx-4 text-center">
            <div class="text-4xl mb-4">
                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
            </div>
            <h3 class="text-xl font-bold mb-4 text-white">포인트 충전 제한</h3>
            <p class="text-gray-200 mb-6">
                현재 보유 포인트가 500을 초과하여<br>
                포인트 충전이 제한됩니다.
            </p>
            <div class="text-sm text-gray-300">
                <p>5초 후 메인 페이지로 이동합니다...</p>
                <p id="countdownText" class="text-yellow-400 font-bold text-lg mt-2">5</p>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let speechQueue = [];
        let isSpeaking = false;

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', async () => {
            // 시청 버튼 이벤트 리스너 추가
            document.getElementById('watchSelectedVideos').addEventListener('click', watchSelectedVideos);
            try {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    
                    // userId가 없는 경우 기본값 설정
                    if (!currentUser.userId) {
                        currentUser.userId = currentUser.name || 'guest_' + Date.now();
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    }
                    
                    console.log('🔍 로드된 사용자 정보:', currentUser);
                    
                    // 사용자 정보 표시
                    document.getElementById('userNameDisplay').textContent = `${currentUser.name}님`;
                    document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                    document.getElementById('loginButton').style.display = 'none';
                    document.getElementById('homeButton').style.display = 'block';

                    // 500포인트 초과 체크
                    if (currentUser.points > 500) {
                        showWarningModal();
                        return;
                    }

                    // 동영상 버튼 활성화
                    enableVideoButton();
                } else {
                    // 로그인하지 않은 사용자
                    document.getElementById('userNameDisplay').textContent = '게스트 사용자';
                    document.getElementById('currentPoints').textContent = '0P';
                    document.getElementById('loginButton').style.display = 'block';
                    document.getElementById('homeButton').style.display = 'none';
                    
                    // 동영상 버튼 비활성화
                    disableVideoButton();
                }
            } catch (error) {
                console.error('사용자 정보 로드 실패:', error);
                disableVideoButton();
            }
        });

        // 동영상 버튼 활성화
        function enableVideoButton() {
            document.getElementById('videoOption').onclick = () => toggleVideoSelection('videoOption');
            document.getElementById('videoOption2').onclick = () => toggleVideoSelection('videoOption2');
            document.getElementById('videoOption3').onclick = () => toggleVideoSelection('videoOption3');
        }

        // 동영상 버튼 비활성화
        function disableVideoButton() {
            const videoButton = document.getElementById('videoOption');
            const videoButton2 = document.getElementById('videoOption2');
            const videoButton3 = document.getElementById('videoOption3');
            
            videoButton.onclick = null;
            videoButton2.onclick = null;
            videoButton3.onclick = null;
            
            videoButton.classList.add('opacity-50', 'cursor-not-allowed');
            videoButton2.classList.add('opacity-50', 'cursor-not-allowed');
            videoButton3.classList.add('opacity-50', 'cursor-not-allowed');
            videoButton.classList.remove('cursor-pointer');
            videoButton2.classList.remove('cursor-pointer');
            videoButton3.classList.remove('cursor-pointer');
        }

        // 동영상 선택 토글
        function toggleVideoSelection(optionId) {
            const option = document.getElementById(optionId);
            const isSelected = option.getAttribute('data-selected') === 'true';
            const checkIcon = option.querySelector('.fa-check-circle');
            
            if (isSelected) {
                // 선택 해제
                option.setAttribute('data-selected', 'false');
                option.classList.remove('ring-4', 'ring-yellow-400');
                checkIcon.style.display = 'none';
            } else {
                // 선택
                option.setAttribute('data-selected', 'true');
                option.classList.add('ring-4', 'ring-yellow-400');
                checkIcon.style.display = 'block';
            }
            
            updateWatchButton();
        }

        // 시청 버튼 업데이트
        function updateWatchButton() {
            const selectedOptions = document.querySelectorAll('[data-selected="true"]');
            const watchButton = document.getElementById('watchSelectedVideos');
            
            if (selectedOptions.length > 0) {
                watchButton.style.display = 'inline-block';
                watchButton.textContent = `선택된 동영상 ${selectedOptions.length}개 시청하기`;
            } else {
                watchButton.style.display = 'none';
            }
        }

        // 선택된 동영상 시청
        async function watchSelectedVideos() {
            if (!currentUser) {
                alert('로그인 후 동영상을 시청해주세요.');
                window.location.href = 'login.html';
                return;
            }

            // 500포인트 초과 체크
            if (currentUser.points > 500) {
                alert('포인트가 500을 초과하여 동영상 시청이 제한됩니다.');
                return;
            }

            const selectedOptions = document.querySelectorAll('[data-selected="true"]');
            if (selectedOptions.length === 0) {
                alert('시청할 동영상을 선택해주세요.');
                return;
            }

            // 선택된 동영상들을 순차적으로 시청
            for (let i = 0; i < selectedOptions.length; i++) {
                const option = selectedOptions[i];
                const optionId = option.id;
                
                // 동영상 모달 표시
                const modal = document.getElementById('videoModal');
                const video = document.getElementById('mascotVideo');
                
                modal.style.display = 'flex';
                video.currentTime = 0;
                video.play();

                // 동영상 완료 대기
                await new Promise((resolve) => {
                    let completed = false;
                    video.onended = async function() {
                        if (completed) return;
                        completed = true;
                        
                        modal.style.display = 'none';
                        video.pause();

                        // 포인트 지급 처리
                        try {
                            const points = 1000;
                            const response = await fetch('/api/update-points', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    userId: currentUser.userId, 
                                    addPoints: points
                                })
                            });

                            if (response.ok) {
                                const data = await response.json();
                                if (data.success) {
                                    currentUser.points = data.points;
                                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                                    document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                                    
                                    speakText(`동영상 시청이 완료되었습니다. ${points.toLocaleString()}포인트가 지급되었습니다.`);
                                    
                                    if (i === selectedOptions.length - 1) {
                                        // 마지막 동영상인 경우
                                        alert(`모든 동영상 시청 완료!\n총 ${(selectedOptions.length * points).toLocaleString()}포인트가 지급되었습니다.`);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('포인트 지급 오류:', error);
                        }
                        
                        resolve();
                    };
                });

                // 동영상 사이에 잠시 대기
                if (i < selectedOptions.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            // 모든 선택 해제
            selectedOptions.forEach(option => {
                option.setAttribute('data-selected', 'false');
                option.classList.remove('ring-4', 'ring-yellow-400');
                option.querySelector('.fa-check-circle').style.display = 'none';
            });
            
            updateWatchButton();
        }

        // 500포인트 초과 경고 모달 표시
        function showWarningModal() {
            const modal = document.getElementById('warningModal');
            modal.style.display = 'flex';
            
            let countdown = 5;
            const countdownElement = document.getElementById('countdownText');
            
            const timer = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    window.location.href = 'index.html';
                }
            }, 1000);
        }

        // 음성 큐 처리 함수
        function processSpeechQueue() {
            if (speechQueue.length === 0 || isSpeaking) {
                return;
            }
            isSpeaking = true;
            const { text, rate, pitch } = speechQueue.shift();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = rate || 0.9;
            utterance.pitch = pitch || 1.1;
            utterance.volume = 0.9;
            utterance.onstart = () => { console.log('🎤 음성 재생 시작:', text); };
            utterance.onend = () => {
                console.log('🎤 음성 재생 완료:', text);
                isSpeaking = false;
                setTimeout(() => processSpeechQueue(), 100);
            };
            utterance.onerror = (event) => {
                console.log('🎤 음성 재생 오류:', event.error);
                isSpeaking = false;
                setTimeout(() => processSpeechQueue(), 100);
            };
            speechSynthesis.speak(utterance);
            console.log('🎤 음성 재생 요청 완료:', text);
        }

        // 음성 재생 함수
        function speakText(text, rate = 0.9) {
            console.log('🎤 음성 재생 시도:', text);
            if ('speechSynthesis' in window) {
                speechQueue.push({ text, rate, pitch: 1.1 });
                console.log('🎤 음성 큐에 추가됨:', text);
                processSpeechQueue();
            } else {
                console.log('🎤 음성 합성 API를 지원하지 않습니다.');
            }
        }

        // 동영상 시청 (첫 번째 메뉴)
        async function watchVideo() {
            if (!currentUser) {
                alert('로그인 후 동영상을 시청해주세요.');
                window.location.href = 'login.html';
                return;
            }

            // 500포인트 초과 체크
            if (currentUser.points > 500) {
                alert('포인트가 500을 초과하여 동영상 시청이 제한됩니다.');
                return;
            }

            // 동영상 모달 표시
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('mascotVideo');
            
            modal.style.display = 'flex';
            video.currentTime = 0; // 동영상 처음부터 재생
            video.play();

            // 동영상 완료 이벤트 리스너
            let completed = false;
            video.onended = async function() {
                if (completed) return;
                completed = true;
                
                modal.style.display = 'none';
                video.pause();

                // 포인트 지급 처리
                try {
                    const points = 1000;
                    console.log('🔍 현재 사용자 정보:', currentUser);
                    console.log('🔍 전송할 데이터:', { userId: currentUser.userId, addPoints: points });
                    
                    const response = await fetch('/api/update-points', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.userId, 
                            addPoints: points
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // 서버 업데이트 성공
                            currentUser.points = data.points;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                            
                            // 동영상 시청 완료 음성
                            speakText(`빠던나인 소개 동영상 시청이 완료되었습니다. ${points.toLocaleString()}포인트가 지급되었습니다.`);
                            alert(`동영상 시청 완료!\n${points.toLocaleString()}포인트가 지급되었습니다.`);
                            
                            // 포인트 충전 후에는 경고 모달 대신 성공 메시지만 표시
                            if (currentUser.points > 500) {
                                console.log('✅ 포인트 충전 완료 - 500포인트 초과로 더 이상 충전 불가');
                            }
                        } else {
                            alert('포인트 지급에 실패했습니다. 다시 시도해주세요.');
                        }
                    } else {
                        alert('서버 연결에 실패했습니다. 다시 시도해주세요.');
                    }
                } catch (error) {
                    console.error('포인트 지급 오류:', error);
                    alert('포인트 지급 중 오류가 발생했습니다. 다시 시도해주세요.');
                }
            }
        }

        // 동영상 시청 (두 번째 메뉴)
        async function watchVideo2() {
            if (!currentUser) {
                alert('로그인 후 동영상을 시청해주세요.');
                window.location.href = 'login.html';
                return;
            }

            // 500포인트 초과 체크
            if (currentUser.points > 500) {
                alert('포인트가 500을 초과하여 동영상 시청이 제한됩니다.');
                return;
            }

            // 동영상 모달 표시
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('mascotVideo');
            
            modal.style.display = 'flex';
            video.currentTime = 0; // 동영상 처음부터 재생
            video.play();

            // 동영상 완료 이벤트 리스너
            let completed = false;
            video.onended = async function() {
                if (completed) return;
                completed = true;
                
                modal.style.display = 'none';
                video.pause();

                // 포인트 지급 처리
                try {
                    const points = 1000;
                    console.log('🔍 현재 사용자 정보:', currentUser);
                    console.log('🔍 전송할 데이터:', { userId: currentUser.userId, addPoints: points });
                    
                    const response = await fetch('/api/update-points', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.userId, 
                            addPoints: points
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // 서버 업데이트 성공
                            currentUser.points = data.points;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                            
                            // 동영상 시청 완료 음성
                            speakText(`빠던나인 소개 동영상 시청이 완료되었습니다. ${points.toLocaleString()}포인트가 지급되었습니다.`);
                            alert(`동영상 시청 완료!\n${points.toLocaleString()}포인트가 지급되었습니다.`);
                            
                            // 포인트 충전 후에는 경고 모달 대신 성공 메시지만 표시
                            if (currentUser.points > 500) {
                                console.log('✅ 포인트 충전 완료 - 500포인트 초과로 더 이상 충전 불가');
                            }
                        } else {
                            alert('포인트 지급에 실패했습니다. 다시 시도해주세요.');
                        }
                    } else {
                        alert('서버 연결에 실패했습니다. 다시 시도해주세요.');
                    }
                } catch (error) {
                    console.error('포인트 지급 오류:', error);
                    alert('포인트 지급 중 오류가 발생했습니다. 다시 시도해주세요.');
                }
            }
        }

        // 동영상 시청 (세 번째 메뉴)
        async function watchVideo3() {
            if (!currentUser) {
                alert('로그인 후 동영상을 시청해주세요.');
                window.location.href = 'login.html';
                return;
            }

            // 500포인트 초과 체크
            if (currentUser.points > 500) {
                alert('포인트가 500을 초과하여 동영상 시청이 제한됩니다.');
                return;
            }

            // 동영상 모달 표시
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('mascotVideo');
            
            modal.style.display = 'flex';
            video.currentTime = 0; // 동영상 처음부터 재생
            video.play();

            // 동영상 완료 이벤트 리스너
            let completed = false;
            video.onended = async function() {
                if (completed) return;
                completed = true;
                
                modal.style.display = 'none';
                video.pause();

                // 포인트 지급 처리
                try {
                    const points = 1000;
                    console.log('🔍 현재 사용자 정보:', currentUser);
                    console.log('🔍 전송할 데이터:', { userId: currentUser.userId, addPoints: points });
                    
                    const response = await fetch('/api/update-points', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser.userId, 
                            addPoints: points
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            // 서버 업데이트 성공
                            currentUser.points = data.points;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            document.getElementById('currentPoints').textContent = `${currentUser.points}P`;
                            
                            // 동영상 시청 완료 음성
                            speakText(`빠던나인 소개 동영상 시청이 완료되었습니다. ${points.toLocaleString()}포인트가 지급되었습니다.`);
                            alert(`동영상 시청 완료!\n${points.toLocaleString()}포인트가 지급되었습니다.`);
                            
                            // 포인트 충전 후에는 경고 모달 대신 성공 메시지만 표시
                            if (currentUser.points > 500) {
                                console.log('✅ 포인트 충전 완료 - 500포인트 초과로 더 이상 충전 불가');
                            }
                        } else {
                            alert('포인트 지급에 실패했습니다. 다시 시도해주세요.');
                        }
                    } else {
                        alert('서버 연결에 실패했습니다. 다시 시도해주세요.');
                    }
                } catch (error) {
                    console.error('포인트 지급 오류:', error);
                    alert('포인트 지급 중 오류가 발생했습니다. 다시 시도해주세요.');
                }
            }
        }

        // 동영상 모달 닫기
        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('mascotVideo');
            
            modal.style.display = 'none';
            video.pause();
            video.currentTime = 0;
        }

        // 음성 합성 함수
        function speakText(text, rate = 0.9) {
            if ('speechSynthesis' in window) {
                // 이전 음성 중지
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = rate;
                utterance.pitch = 1.1;
                utterance.volume = 0.9;
                
                // 음성 완료 이벤트
                utterance.onend = () => {
                    console.log('🎤 음성 재생 완료:', text);
                };
                
                utterance.onerror = (event) => {
                    console.log('🎤 음성 재생 오류:', event.error);
                };
                
                speechSynthesis.speak(utterance);
            }
        }
    </script>
</body>
</html> 